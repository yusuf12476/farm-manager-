<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Tracker Pro</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Load jsPDF and autoTable plugin for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf-autotable.min.js"></script>
    
    <!-- Configure Tailwind for custom colors and font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#059669', // Emerald 600 - Deeper, richer green
                        'primary-green-dark': '#047857', // Emerald 700
                        'secondary-yellow': '#f59e0b', // Amber 500 - Rich yellow/orange
                        'bg-light': '#f4f7f9', // Very light, professional background
                        'card-bg': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif; /* Use the custom font */
            background-color: theme('colors.bg-light');
            color: theme('colors.gray.700');
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .gradient-text {
            background: linear-gradient(to right, theme('colors.primary-green'), theme('colors.primary-green-dark'));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .active-tab {
            color: #059669;
            font-weight: 600;
            position: relative;
        }

        /* Underline effect for active tab */
        .active-tab::after {
            content: '';
            position: absolute;
            bottom: -2px; /* Adjusted for the border */
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #059669;
            border-radius: 9999px;
        }

        /* Custom scrollbar for data lists */
        #transaction-list-container::-webkit-scrollbar,
        #production-list-container::-webkit-scrollbar {
            width: 6px;
        }
        #transaction-list-container::-webkit-scrollbar-thumb,
        #production-list-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 3px;
        }

        /* Custom class for input focus */
        .input-focus:focus {
            --tw-ring-shadow: 0 0 0 2px rgba(5, 150, 105, 0.5);
            box-shadow: var(--tw-ring-shadow);
            border-color: #059669;
        }

        .nav-scrollbar::-webkit-scrollbar {
            height: 4px;
        }
        .nav-scrollbar::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 2px;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-bg-light z-[100] flex flex-col items-center justify-center transition-opacity duration-700 ease-in-out">
        <div class="text-center">
            <div class="text-4xl md:text-5xl font-extrabold text-gray-800 flex items-center">
                <svg class="w-10 h-10 md:w-12 md:h-12 mr-3 md:mr-4 gradient-text" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"></path></svg>
                Farm Tracker <span class="gradient-text ml-2">Pro</span>
            </div>
            <p class="mt-4 text-gray-500 animate-pulse">Loading your farm data...</p>
        </div>
    </div>


    <!-- Password/Setup Modal -->
    <div id="security-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-[101] flex items-center justify-center p-4">
        <div class="bg-card-bg p-6 md:p-8 rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300 scale-95 opacity-0" id="security-modal-container">
            <!-- Content will be injected by JS -->
            <div id="security-modal-content">
                <h3 class="text-lg md:text-xl font-bold mb-4 text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    Security Check
                </h3>
                <p class="text-gray-600 animate-pulse">Checking for encrypted data...</p>
            </div>
        </div>
    </div>


    <!-- Main App Container (Initially hidden) -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-10 opacity-0 transition-opacity duration-500">
        <!-- Header -->
        <header class="mb-8 p-4 md:p-6 bg-gradient-to-br from-white to-emerald-50/50 shadow-sm rounded-2xl border border-gray-200/80">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 flex items-center">
                    <svg class="w-8 h-8 md:w-10 md:h-10 mr-2 md:mr-3 gradient-text" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"></path></svg>
                    Farm Tracker <span class="gradient-text ml-2">Pro</span>
                </h1>
                <div class="flex items-center space-x-2">
                    <button onclick="changeView('settings')" class="flex items-center space-x-2 px-3 py-2 text-sm font-medium text-gray-600 bg-white rounded-lg shadow-sm border border-gray-200 hover:bg-gray-100 transition">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span>Settings</span>
                    </button>
                    <button onclick="handleLogout()" class="flex items-center space-x-2 px-3 py-2 text-sm font-medium text-gray-600 bg-white rounded-lg shadow-sm border border-gray-200 hover:bg-gray-100 transition">
                        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
            <p id="auth-status" class="text-sm text-gray-500 mt-2">Initializing...</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="border-b-2 border-gray-200 mb-8 relative">
            <!-- Mobile Navigation Dropdown (Hidden on md and up) -->
            <div class="md:hidden">
                <button onclick="toggleNavDropdown()" id="nav-dropdown-button" class="w-full flex justify-between items-center py-3 px-4 border border-gray-300 rounded-lg bg-white text-left">
                    <span id="nav-dropdown-label" class="font-semibold text-gray-700">Dashboard</span>
                    <svg class="w-5 h-5 text-gray-500 transform transition-transform" id="nav-dropdown-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="nav-dropdown-menu" class="hidden absolute top-full left-0 w-full mt-1 bg-white rounded-lg shadow-xl border border-gray-200 z-20">
                    <a onclick="selectNavDropdownItem('dashboard')" class="block px-4 py-3 text-gray-700 hover:bg-gray-100" data-nav="dashboard">Dashboard</a>
                    <a onclick="selectNavDropdownItem('livestock')" class="block px-4 py-3 text-gray-700 hover:bg-gray-100" data-nav="livestock">Livestock</a>
                    <a onclick="selectNavDropdownItem('finance')" class="block px-4 py-3 text-gray-700 hover:bg-gray-100" data-nav="finance">Finance</a>
                    <a onclick="selectNavDropdownItem('production')" class="block px-4 py-3 text-gray-700 hover:bg-gray-100" data-nav="production">Production</a>
                    <a onclick="selectNavDropdownItem('tasks')" class="block px-4 py-3 text-gray-700 hover:bg-gray-100" data-nav="tasks">Tasks</a>
                    <a onclick="selectNavDropdownItem('inventory')" class="block px-4 py-3 text-gray-700 hover:bg-gray-100" data-nav="inventory">Inventory</a>
                    <a onclick="selectNavDropdownItem('animalhub')" class="block px-4 py-3 text-gray-700 hover:bg-gray-100" data-nav="animalhub">Animal Hub</a>
                    <a onclick="selectNavDropdownItem('equipment')" class="block px-4 py-3 text-gray-700 hover:bg-gray-100" data-nav="equipment">Equipment</a>
                    <a onclick="selectNavDropdownItem('analytics')" class="block px-4 py-3 text-gray-700 hover:bg-gray-100" data-nav="analytics">Analytics</a>
                </div>
            </div>
            <!-- Desktop Navigation (Visible on md and up) -->
            <div class="hidden md:flex space-x-4 md:space-x-8 overflow-x-auto pb-2 -mb-2 nav-scrollbar">
                <button onclick="changeView('dashboard')" id="tab-dashboard" class="py-3 px-3 text-gray-600 hover:text-primary-green transition duration-200 whitespace-nowrap active-tab">Dashboard</button>
                <button onclick="changeView('livestock')" id="tab-livestock" class="py-3 px-3 text-gray-600 hover:text-primary-green transition duration-200 whitespace-nowrap">Livestock</button>
                <button onclick="changeView('finance')" id="tab-finance" class="py-3 px-3 text-gray-600 hover:text-primary-green transition duration-200 whitespace-nowrap">Finance</button>
                <button onclick="changeView('production')" id="tab-production" class="py-3 px-3 text-gray-600 hover:text-primary-green transition duration-200 whitespace-nowrap">Production</button>
                <button onclick="changeView('tasks')" id="tab-tasks" class="py-3 px-3 text-gray-600 hover:text-primary-green transition duration-200 whitespace-nowrap">Tasks</button>
                <button onclick="changeView('inventory')" id="tab-inventory" class="py-3 px-3 text-gray-600 hover:text-primary-green transition duration-200 whitespace-nowrap">Inventory</button>
                <button onclick="changeView('animalhub')" id="tab-animalhub" class="py-3 px-3 text-gray-600 hover:text-primary-green transition duration-200 whitespace-nowrap">Animal Hub</button>
                <button onclick="changeView('equipment')" id="tab-equipment" class="py-3 px-3 text-gray-600 hover:text-primary-green transition duration-200 whitespace-nowrap">Equipment</button>
                <button onclick="changeView('analytics')" id="tab-analytics" class="py-3 px-3 text-gray-600 hover:text-primary-green transition duration-200 whitespace-nowrap">Analytics</button>
            </div>
        </nav>

        <!-- Main Content Area (View Containers) -->
        <div id="view-dashboard" class="view-container">
            <!-- Dashboard content will be rendered here -->
        </div>

        <div id="view-livestock" class="view-container hidden">
            <!-- Livestock content will be rendered here -->
        </div>

        <div id="view-finance" class="view-container hidden">
            <!-- Finance content will be rendered here -->
        </div>

        <div id="view-production" class="view-container hidden">
            <!-- Production content will be rendered here -->
        </div>

        <div id="view-tasks" class="view-container hidden">
            <!-- Tasks content will be rendered here -->
        </div>

        <div id="view-inventory" class="view-container hidden">
            <!-- Inventory content will be rendered here -->
        </div>

        <div id="view-animalhub" class="view-container hidden">
            <!-- Animal Hub content will be rendered here -->
        </div>

        <div id="view-equipment" class="view-container hidden">
            <!-- Equipment content will be rendered here -->
        </div>

        <div id="view-analytics" class="view-container hidden">
            <!-- Analytics content will be rendered here -->
        </div>

        <div id="view-settings" class="view-container hidden">
            <!-- Settings content will be rendered here -->
        </div>

    </div>

    <!-- 1. DELETE Confirmation Modal -->
    <div id="delete-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-card-bg p-6 md:p-8 rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300 scale-95 opacity-0" id="delete-modal-content">
            <h3 class="text-lg md:text-xl font-bold mb-4 text-red-600 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                Confirm Deletion
            </h3>
            <p id="delete-modal-message" class="mb-6 text-gray-700">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('delete')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">Cancel</button>
                <button id="delete-modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium shadow-md">Delete Permanently</button>
            </div>
        </div>
    </div>

    <!-- 2. EDIT Modal -->
    <div id="edit-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-card-bg p-6 md:p-8 rounded-2xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95 opacity-0" id="edit-modal-content">
            <h3 id="edit-modal-title" class="text-xl md:text-2xl font-bold mb-5 pb-2 border-b-2 border-primary-green/20 text-primary-green">Edit Record</h3>
            <form id="edit-form" onsubmit="event.preventDefault(); handleUpdateRecord();">
                <!-- Form content is injected here dynamically by JS -->
                <div id="edit-form-content" class="grid grid-cols-1 gap-4">
                    <p class="text-gray-500">Loading form...</p>
                </div>
                
                <p id="edit-msg" class="text-center mt-4 text-sm font-medium hidden"></p>

                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-100">
                    <button type="button" onclick="closeModal('edit')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-primary-green text-white rounded-lg font-bold hover:bg-primary-green-dark transition shadow-md shadow-primary-green/30">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LOCAL DATA SCRIPT -->
    <script>
        // --- LOCAL DATA STATE ---
        let isAuthReady = false;
        let currentEditingRecord = null; // Stores the id and collection of the record being edited

        // Global filter state and chart instances for Finance tab
        let viewFilters = {
            finance: {
                type: 'all',
                category: 'all',
                dateRange: 'all',
                startDate: null,
                endDate: null
            },
            tasks: { isOverdue: false }
        };
        let expenseChart = null;
        let monthlyChart = null;
        let incomeChart = null;
        let yoyProductionChart = null;
        let productionTrendChart = null;
        let livestockCompositionChart = null;
        let populationGrowthChart = null;
        let taskStatusChart = null;

        let profitabilityForecastChart = null;
        // Inactivity timer state
        let inactivityTimer;
        const INACTIVITY_TIMEOUT = 15 * 60 * 1000; // 15 minutes

        // --- LOCAL STORAGE & DATA MANAGEMENT ---
        let owner = null; // Will hold { userId, password }

        /**
         * Saves the entire farmData object to local storage.
         */
        const saveData = () => localStorage.setItem('farmData', JSON.stringify(window.farmData));


        window.farmData = {
            livestock: [],
            transactions: [],
            production: [],
            tasks: [],
            inventory: [],
            breeding: [],
            health: [],
            equipment: [],
            // Available options for the UI
            livestockTypes: ["bees", "heifers", "bulls", "chicken", "duck", "geese", "fish", "goats", "sheep", "turkey"],
            productionTypes: ["Milk (Liters)", "Eggs (Dozens)", "Honey (KGs)"],
            transactionCategories: {
                'expense': ['Feed/Hay', 'Fertilizer/Seed', 'Equipment/Maintenance', 'Labor', 'Fuel/Utilities', 'Other Input'],
                'income': ['Sales: Cattle', 'Sales: Poultry', 'Sales: Wool/Fiber', 'Sales: Honey', 'Sales: Dairy', 'Other Income']
            },
            taskPriorities: ['High', 'Medium', 'Low'],
            taskStatuses: ['To Do', 'In Progress', 'Done'],
            inventoryCategories: ['Feed', 'Medicine', 'Fertilizer', 'Seed', 'Equipment Part', 'Fuel', 'Other Supplies'],
            animalSpecies: ['Cattle', 'Swine', 'Sheep', 'Goats', 'Poultry', 'Other'],
            breedingStatuses: ['In Calf/Farrow', 'Calved/Farrowed', 'Open/Unserved', 'Confirmed'],
            // Average Gestation Periods in days (used for simple EDD calculation)
            gestationDays: { 'Cattle': 283, 'Swine': 114, 'Sheep': 150, 'Goats': 150, 'Poultry': 21, 'Other': 283 }
        };

        /**
         * Loads the finance filter state from localStorage.
         */
        function loadFiltersFromLocalStorage() {
            const storedFilters = localStorage.getItem('farmViewFilters');
            if (storedFilters) {
                try {
                    const loadedFilters = JSON.parse(storedFilters);
                    viewFilters = { ...viewFilters, ...loadedFilters };
                } catch (e) { console.error("Could not parse finance filters from localStorage", e); }
            }
        }

        /**
         * Renders the content of the security modal (setup or login).
         */
        function renderSecurityModal(state, message = '') {
            const content = document.getElementById('security-modal-content');
            let html = '';
            const errorHtml = message ? `<p class="text-red-500 text-sm font-medium mt-3 text-center">${message}</p>` : '';

            if (state === 'setup') {
                html = `
                    <h3 class="text-lg md:text-xl font-bold mb-2 text-gray-800">Create Your Account</h3>
                    <p class="text-sm text-gray-600 mb-4">Create a User ID and password to secure your farm data.</p>
                    <form onsubmit="event.preventDefault(); handleCreateUser();">
                        <input type="text" id="setup-userid" required placeholder="Create a User ID" class="input-focus w-full p-3 border border-gray-300 rounded-lg mb-2">
                        <input type="password" id="setup-password" required placeholder="Create a strong password" class="input-focus w-full p-3 border border-gray-300 rounded-lg mb-2">
                        <input type="password" id="setup-password-confirm" required placeholder="Confirm password" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                        ${errorHtml}
                        <button type="submit" class="w-full mt-4 bg-primary-green text-white py-3 rounded-lg font-bold hover:bg-primary-green-dark transition">Create Account & Start</button>
                    </form>
                `;
            } else { // 'login'
                html = `
                    <h3 id="login-title" class="text-lg md:text-xl font-bold mb-4 text-gray-800">Login to Your Farm</h3>
                    <form onsubmit="event.preventDefault(); handleLogin();">
                        <div id="login-step-1">
                            <input type="text" id="login-userid" required placeholder="Your User ID" class="input-focus w-full p-3 border border-gray-300 rounded-lg mb-2" pattern="[a-z0-9_]+">
                            <input type="password" id="login-password" required placeholder="Your Password" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        ${errorHtml}
                        <button type="submit" class="w-full mt-4 bg-primary-green text-white py-3 rounded-lg font-bold hover:bg-primary-green-dark transition">Unlock</button>
                    </form>
                    <div class="flex justify-between items-center mt-4">
                        <button onclick="renderSecurityModal('setup')" class="text-xs text-blue-500 hover:underline">Create a new account</button>
                        <button onclick="handleResetApp()" class="text-xs text-gray-500 hover:text-red-600 hover:underline">Forgot password?</button>
                    </div>
                `;
            }
            content.innerHTML = html;
        }

        async function handleCreateUser() {
            const userId = document.getElementById('setup-userid').value.trim();
            const pass = document.getElementById('setup-password').value;
            const confirmPass = document.getElementById('setup-password-confirm').value;

            if (pass.length < 6) {
                renderSecurityModal('setup', 'Password must be at least 6 characters long.');
                return;
            }
            if (pass !== confirmPass) {
                renderSecurityModal('setup', 'Passwords do not match.');
                return;
            }
            
            owner = { userId, password: pass };
            localStorage.setItem('farmOwner', JSON.stringify(owner));

            // After successful registration, log in automatically
            await handleLogin(userId, pass);
        }

        /**
         * Logs the user out by reloading the page, which will trigger the security check.
         */
        async function handleLogout() {
            try {
                await fetch('auth.php?action=logout'); // This can be removed, but harmless if it fails
            } catch (error) {}
            window.location.reload();
        }

        // --- ANIMAL HUB (BREEDING & HEALTH) ---

        /**
         * Calculates the difference in days between a future date string and today.
         */
        function getDaysDifference(futureDateStr) {
            const future = new Date(futureDateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffTime = future.getTime() - today.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        /**
         * Calculates the expected due date based on service date and species.
         */
        function calculateDueDate(serviceDate, species) {
            if (!serviceDate) return '';
            const gestation = farmData.gestationDays[species] || farmData.gestationDays['Other'];
            const date = new Date(serviceDate);
            date.setDate(date.getDate() + gestation);
            return date.toISOString().split('T')[0]; // Return YYYY-MM-DD
        }

        /**
         * Renders the Breeding Tracker view content.
         */
        function renderBreedingTracker(formState = {}) {
            const records = farmData.breeding;
            const serviceDate = formState.serviceDate || new Date().toISOString().substring(0, 10);
            const species = formState.species || farmData.animalSpecies[0];
            const newRecordDueDate = calculateDueDate(serviceDate, species);
            return `
                <div class="bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 mb-8">
                    <h3 class="text-xl font-bold mb-5 border-b pb-3 text-gray-800">Add New Service Record</h3>
                    <form id="add-breeding-form" onsubmit="event.preventDefault(); handleAddBreedingRecord();" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <input type="text" id="breeding-animal-id" required placeholder="Animal ID (e.g., Cow #102)" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                            <select id="breeding-species" required class="input-focus w-full p-3 border border-gray-300 rounded-lg" onchange="handleBreedingFormChange()">
                                ${farmData.animalSpecies.map(s => `<option value="${s}" ${s === species ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                            <input type="date" id="breeding-service-date" required class="input-focus w-full p-3 border border-gray-300 rounded-lg" value="${serviceDate}" onchange="handleBreedingFormChange()">
                            <button type="submit" class="w-full bg-primary-green text-white py-3 rounded-lg font-bold hover:bg-primary-green-dark transition shadow-md">Log Service</button>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 italic">*Estimated due date: <span class="font-semibold">${newRecordDueDate || 'N/A'}</span></p>
                            <p id="breeding-msg" class="text-center mt-3 text-sm font-medium"></p>
                        </div>
                    </form>
                </div>
                <div class="bg-card-bg rounded-2xl shadow-lg overflow-hidden border border-gray-200/80">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Animal ID</th>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Species</th>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Service Date</th>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Due Date</th>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Due In</th>
                                    <th class="px-5 py-3 text-right">Actions</th>
                                </tr>
                                <tr>
                                    <td colspan="7" class="px-5 py-2 bg-gray-100 text-right">
                                        <button onclick="handleExportPdf('breeding')" class="px-3 py-1.5 text-xs font-medium bg-white text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center space-x-1 shadow-sm border border-gray-300 ml-auto"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Export PDF</span></button>
                                    </td>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                ${records.length > 0 ? records.map(rec => {
                                    const daysRemaining = getDaysDifference(rec.expectedDueDate);
                                    const isDue = rec.status === 'In Calf/Farrow' && daysRemaining <= 14;
                                    const statusClasses = rec.status === 'Calved/Farrowed' ? 'bg-green-100 text-green-700' : (rec.status === 'Open/Unserved' ? 'bg-gray-100 text-gray-700' : (isDue ? 'bg-red-100 text-red-700 font-bold' : 'bg-blue-100 text-blue-700'));
                                    return `
                                        <tr class="hover:bg-gray-50/80">
                                            <td class="px-5 py-3 font-semibold">${rec.animalId}</td>
                                            <td class="px-5 py-3 text-sm">${rec.species}</td>
                                            <td class="px-5 py-3 text-sm">${rec.serviceDate}</td>
                                            <td class="px-5 py-3 text-sm">${rec.expectedDueDate}</td>
                                            <td class="px-5 py-3"><span class="px-2 py-1 text-xs rounded-full ${statusClasses}">${rec.status}</span></td>
                                            <td class="px-5 py-3 text-sm font-medium ${daysRemaining <= 0 ? 'text-red-600' : 'text-blue-600'}">
                                                ${rec.status === 'In Calf/Farrow' ? (daysRemaining > 0 ? `${daysRemaining} days` : 'OVERDUE') : 'N/A'}
                                            </td>
                                            <td class="px-5 py-3 text-right space-x-2">
                                                <select onchange="handleUpdateBreedingStatus('${rec.id}', this.value)" class="text-xs p-1 border border-gray-300 rounded-md">
                                                    ${farmData.breedingStatuses.map(s => `<option value="${s}" ${rec.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                                </select>
                                                <button onclick="window.confirmDelete('${rec.id}', 'breeding')" class="text-red-600 hover:text-red-800 p-1.5 rounded-full hover:bg-red-100" title="Delete">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('') : `<tr><td colspan="7" class="px-5 py-10 text-center text-gray-500 italic">No breeding records found.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the Health Tracker view content.
         */
        function renderHealthTracker() {
            const records = farmData.health;
            return `
                <div class="bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 mb-8">
                    <h3 class="text-xl font-bold mb-5 border-b pb-3 text-gray-800">Log New Health Event</h3>
                    <form id="add-health-form" onsubmit="event.preventDefault(); handleAddHealthRecord();" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="text" id="health-animal-id" required placeholder="Animal ID" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                            <input type="date" id="health-record-date" required class="input-focus w-full p-3 border border-gray-300 rounded-lg" value="${new Date().toISOString().substring(0, 10)}">
                            <input type="text" id="health-vet" placeholder="Veterinarian (Optional)" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <textarea id="health-diagnosis" required rows="2" placeholder="Diagnosis (e.g., Pneumonia)" class="input-focus w-full p-3 border border-gray-300 rounded-lg"></textarea>
                            <textarea id="health-treatment" rows="2" placeholder="Treatment (e.g., 5cc Penicillin)" class="input-focus w-full p-3 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-primary-green text-white py-3 rounded-lg font-bold hover:bg-primary-green-dark transition shadow-md">Log Health Record</button>
                        <div>
                            <p id="health-msg" class="text-center mt-3 text-sm font-medium"></p>
                        </div>
                    </form>
                </div>
                <div class="bg-card-bg rounded-2xl shadow-lg overflow-hidden border border-gray-200/80">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Date</th>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Animal ID</th>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Diagnosis</th>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Treatment</th>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Vet</th>
                                    <th class="px-5 py-3 text-right">Action</th>
                                </tr>
                                <tr>
                                    <td colspan="6" class="px-5 py-2 bg-gray-100 text-right">
                                        <button onclick="handleExportPdf('health')" class="px-3 py-1.5 text-xs font-medium bg-white text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center space-x-1 shadow-sm border border-gray-300 ml-auto"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Export PDF</span></button>
                                    </td>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                ${records.length > 0 ? records.map(rec => `
                                    <tr class="hover:bg-gray-50/80">
                                        <td class="px-5 py-3 text-sm">${rec.recordDate}</td>
                                        <td class="px-5 py-3 font-semibold">${rec.animalId}</td>
                                        <td class="px-5 py-3 text-sm max-w-xs truncate">${rec.diagnosis}</td>
                                        <td class="px-5 py-3 text-sm max-w-xs truncate">${rec.treatment || 'N/A'}</td>
                                        <td class="px-5 py-3 text-sm">${rec.veterinarian || 'N/A'}</td>
                                        <td class="px-5 py-3 text-right">
                                            <button onclick="window.confirmDelete('${rec.id}', 'health')" class="text-red-600 hover:text-red-800 p-1.5 rounded-full hover:bg-red-100" title="Delete">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('') : `<tr><td colspan="6" class="px-5 py-10 text-center text-gray-500 italic">No health records found.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the main Animal Hub view with sub-tabs.
         */
        function renderAnimalHub(activeSubView = 'breeding', breedingFormState = {}) {
            const container = document.getElementById('view-animalhub');
            
            const getSubTabClass = (tabName) => activeSubView === tabName 
                ? 'border-primary-green text-primary-green font-semibold' 
                : 'border-transparent text-gray-500 hover:text-gray-800';

            let contentHtml = '';
            if (activeSubView === 'breeding') {
                contentHtml = renderBreedingTracker(breedingFormState);
            } else { // 'health'
                contentHtml = renderHealthTracker();
            }

            container.innerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Animal Hub</h2>
                <p class="text-gray-600 mb-8">Track individual animal breeding cycles and health records.</p>
                
                <div class="mb-8">
                    <div class="flex space-x-6 border-b-2 border-gray-200">
                        <button onclick="renderAnimalHub('breeding')" class="py-3 px-2 text-lg border-b-4 ${getSubTabClass('breeding')}">
                            Breeding Tracker
                        </button>
                        <button onclick="renderAnimalHub('health')" class="py-3 px-2 text-lg border-b-4 ${getSubTabClass('health')}">
                            Health Tracker
                        </button>
                    </div>
                </div>

                <div id="animal-hub-content">
                    ${contentHtml}
                </div>
            `;
        }

        window.handleBreedingFormChange = function() {
            const serviceDate = document.getElementById('breeding-service-date')?.value;
            const species = document.getElementById('breeding-species')?.value;
            renderAnimalHub('breeding', { serviceDate, species });
        }

        window.handleAddBreedingRecord = async function() {
            const animalId = document.getElementById('breeding-animal-id').value.trim();
            const species = document.getElementById('breeding-species').value;
            const serviceDate = document.getElementById('breeding-service-date').value;
            const msgEl = document.getElementById('breeding-msg');

            if (!animalId || !species || !serviceDate) {
                msgEl.textContent = 'Please fill all fields.';
                msgEl.className = 'text-center mt-3 text-sm text-red-500 font-medium';
                return;
            }

            const record = {
                animalId,
                species,
                serviceDate,
                status: 'In Calf/Farrow', // Default status
                expectedDueDate: calculateDueDate(serviceDate, species)
            };

            record.id = Date.now().toString(); // Assign a local unique ID
            farmData.breeding.push(record);
            farmData.breeding.sort((a, b) => new Date(b.serviceDate) - new Date(a.serviceDate));
            saveData();
            renderAnimalHub('breeding');

            msgEl.textContent = `Breeding record for ${animalId} added.`;
            msgEl.className = 'text-center mt-3 text-sm text-green-600 font-medium';
            setTimeout(() => msgEl.textContent = '', 3000);
        }

        window.handleAddHealthRecord = async function() {
            const animalId = document.getElementById('health-animal-id').value.trim();
            const recordDate = document.getElementById('health-record-date').value;
            const diagnosis = document.getElementById('health-diagnosis').value.trim();
            const treatment = document.getElementById('health-treatment').value.trim();
            const veterinarian = document.getElementById('health-vet').value.trim();
            const msgEl = document.getElementById('health-msg');

            if (!animalId || !recordDate || !diagnosis) {
                msgEl.textContent = 'Animal ID, Date, and Diagnosis are required.';
                msgEl.className = 'text-center mt-3 text-sm text-red-500 font-medium';
                return;
            }

            const record = {
                id: Date.now().toString(),
                animalId,
                recordDate,
                diagnosis,
                treatment,
                veterinarian
            };

            farmData.health.push(record);
            farmData.health.sort((a, b) => new Date(b.recordDate) - new Date(a.recordDate));
            saveData();
            renderAnimalHub('health');

            msgEl.textContent = `Health record for ${animalId} added.`;
            msgEl.className = 'text-center mt-3 text-sm text-green-600 font-medium';
            setTimeout(() => msgEl.textContent = '', 3000);
        }

        window.handleUpdateBreedingStatus = async function(id, newStatus) {
            const record = getRecordById(id, 'breeding');
            if (record) {
                const originalStatus = record.status;
                try {
                    record.status = newStatus; // Optimistic update
                    renderAnimalHub('breeding');

                    saveData(); // Save the change
                } catch (error) {
                    record.status = originalStatus; // Revert on failure
                    renderAnimalHub('breeding');
                    alert('Could not update breeding status. Please try again.');
                }
            }
        }

        /**
         * Renders the Equipment Maintenance Log view.
         */
        function renderEquipment(equipmentList) {
            const container = document.getElementById('view-equipment');
            const sortedEquipment = equipmentList.slice().sort((a, b) => a.name.localeCompare(b.name));

            container.innerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-8">Equipment & Maintenance</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Add Equipment Form -->
                    <div class="lg:col-span-1 bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 h-fit">
                        <h3 class="text-xl font-bold mb-5 border-b pb-3 text-gray-800">Add New Equipment</h3>
                        <form id="add-equipment-form" onsubmit="event.preventDefault(); handleAddEquipment();">
                            <div class="mb-4">
                                <label for="equipment-name" class="block text-sm font-medium text-gray-700 mb-1">Equipment Name</label>
                                <input type="text" id="equipment-name" required placeholder="e.g., John Deere 8R Tractor" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="equipment-model" class="block text-sm font-medium text-gray-700 mb-1">Model/Serial Number</label>
                                <input type="text" id="equipment-model" placeholder="e.g., 8R 370 / #12345" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="equipment-purchase-date" class="block text-sm font-medium text-gray-700 mb-1">Purchase Date</label>
                                <input type="date" id="equipment-purchase-date" required class="input-focus w-full p-3 border border-gray-300 rounded-lg" value="${new Date().toISOString().substring(0, 10)}">
                            </div>
                            <button type="submit" class="w-full bg-primary-green text-white py-3 rounded-lg font-bold hover:bg-primary-green-dark transition shadow-md">Add to Fleet</button>
                            <p id="equipment-msg" class="text-center mt-3 text-sm font-medium"></p>
                        </form>
                    </div>

                    <!-- Equipment List -->
                    <div class="lg:col-span-2">
                        <h3 class="text-xl font-bold mb-5 pb-3 border-b text-gray-800">Your Fleet (${sortedEquipment.length})</h3>
                        <div class="space-y-6">
                            ${sortedEquipment.length > 0 ? sortedEquipment.map(item => `
                                <div class="bg-card-bg p-6 rounded-2xl shadow-lg border border-gray-200/80">
                                    <div class="flex justify-between items-start border-b pb-4 mb-4">
                                        <div>
                                            <h4 class="text-lg font-bold text-primary-green">${item.name}</h4>
                                            <p class="text-sm text-gray-600">${item.model || 'No model info'}</p>
                                            <p class="text-xs text-gray-500 mt-1">Purchased: ${item.purchaseDate}</p>
                                        </div>
                                        <div class="flex-shrink-0 space-x-2">
                                            <button onclick="window.openEditModal('${item.id}', 'equipment')" class="text-blue-600 hover:text-blue-800 p-1.5 rounded-full hover:bg-blue-100" title="Edit Equipment Details">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-3l-4 4V14h3l4-4M16 5l3 3m-8 10h.01"></path></svg>
                                            </button>
                                            <button onclick="window.confirmDelete('${item.id}', 'equipment')" class="text-red-600 hover:text-red-800 p-1.5 rounded-full hover:bg-red-100" title="Delete Equipment">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Maintenance Log Section -->
                                    <h5 class="font-semibold text-gray-700 mb-3">Maintenance Log</h5>
                                    <div class="space-y-3 max-h-48 overflow-y-auto pr-2 mb-4">
                                        ${item.maintenanceLog && item.maintenanceLog.length > 0 ? item.maintenanceLog.sort((a,b) => new Date(b.date) - new Date(a.date)).map(log => `
                                            <div class="text-sm p-3 bg-gray-50 rounded-lg border border-gray-200">
                                                <p class="font-semibold text-gray-800">${log.description}</p>
                                                <p class="text-xs text-gray-500">On: ${log.date} | Cost: KSh ${parseFloat(log.cost || 0).toFixed(2)}</p>
                                            </div>
                                        `).join('') : '<p class="text-xs text-gray-500 italic text-center py-2">No maintenance records yet.</p>'}
                                    </div>

                                    <!-- Add Maintenance Form -->
                                    <form onsubmit="event.preventDefault(); handleAddMaintenanceRecord('${item.id}');" class="mt-4 pt-4 border-t space-y-2">
                                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                            <input type="text" id="maint-desc-${item.id}" required placeholder="Service Description" class="input-focus w-full p-2 text-sm border border-gray-300 rounded-lg col-span-3 sm:col-span-1">
                                            <input type="number" id="maint-cost-${item.id}" placeholder="Cost (KSh)" step="0.01" class="input-focus w-full p-2 text-sm border border-gray-300 rounded-lg">
                                            <input type="date" id="maint-date-${item.id}" required class="input-focus w-full p-2 text-sm border border-gray-300 rounded-lg" value="${new Date().toISOString().substring(0, 10)}">
                                        </div>
                                        <button type="submit" class="w-full mt-2 bg-secondary-yellow text-white py-2 text-sm rounded-lg font-bold hover:bg-amber-600 transition">Add Log Entry</button>
                                    </form>
                                </div>
                            `).join('') : `
                                <div class="text-center text-gray-500 italic py-10 bg-card-bg rounded-2xl shadow-lg border border-gray-200/80">
                                    <p>Your equipment fleet is empty.</p>
                                    <p class="text-sm">Use the form on the left to add your first tractor, combine, or other machinery.</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        window.handleAddEquipment = async function() {
            const name = document.getElementById('equipment-name').value.trim();
            const model = document.getElementById('equipment-model').value.trim();
            const purchaseDate = document.getElementById('equipment-purchase-date').value;
            const msgEl = document.getElementById('equipment-msg');

            if (!name || !purchaseDate) {
                msgEl.textContent = 'Name and Purchase Date are required.';
                msgEl.className = 'text-center mt-3 text-sm text-red-500 font-medium';
                return;
            }

            const record = {
                name,
                model,
                purchaseDate
            };

            record.id = Date.now().toString();
            record.maintenanceLog = []; // Initialize with empty log
            farmData.equipment.push(record);
            saveData();
            renderEquipment(farmData.equipment);

            msgEl.textContent = `Equipment '${name}' added.`;
            msgEl.className = 'text-center mt-3 text-sm text-green-600 font-medium';
            document.getElementById('add-equipment-form').reset();
            document.getElementById('equipment-purchase-date').value = new Date().toISOString().substring(0, 10);
            setTimeout(() => msgEl.textContent = '', 3000);
        }

        window.handleAddMaintenanceRecord = async function(equipmentId) {
            const equipment = getRecordById(equipmentId, 'equipment');
            if (!equipment) return;

            const description = document.getElementById(`maint-desc-${equipmentId}`).value.trim();
            const cost = document.getElementById(`maint-cost-${equipmentId}`).value;
            const date = document.getElementById(`maint-date-${equipmentId}`).value;

            if (!description || !date) {
                alert('Please provide a description and date for the maintenance log.');
                return;
            }

            const logEntry = {
                id: Date.now().toString(),
                equipmentId,
                description,
                cost: parseFloat(cost) || 0,
                date
            };

            equipment.maintenanceLog.push(logEntry);
            saveData();
            renderEquipment(farmData.equipment);
        }

        // --- INITIALIZATION ---

        /**
         * Initializes the local application, loads data, and sets up the UI.
         */
        async function initializeLocalApp() {
            const modalContainer = document.getElementById('security-modal-container');
            const ownerData = localStorage.getItem('farmOwner');

            if (ownerData) {
                owner = JSON.parse(ownerData);
                renderSecurityModal('login');
            } else {
                renderSecurityModal('setup', 'Welcome! Create the primary account for your farm.');
            }
            modalContainer.classList.remove('scale-95', 'opacity-0');
            modalContainer.classList.add('scale-100', 'opacity-100');
        }

        async function handleLogin(prefilledUserId = null, prefilledPassword = null) {
            const userId = prefilledUserId || document.getElementById('login-userid').value.trim();
            const password = prefilledPassword || document.getElementById('login-password').value;

            // If owner isn't loaded (e.g., direct login after setup), load it.
            if (!owner) {
                const ownerData = localStorage.getItem('farmOwner');
                if (ownerData) {
                    owner = JSON.parse(ownerData);
                }
            }

            if (owner && owner.userId === userId && owner.password === password) {
                await startApp(owner.userId);
            } else {
                renderSecurityModal('login', 'Invalid User ID or password.');
            }
        }

        function handleResetApp() {            
            if (confirm("Are you sure you want to reset the application? This will delete ALL your data and the account. This action cannot be undone.")) {
                localStorage.clear();
                window.location.reload();
            }
        }

        /**
         * Starts the main application after successful login/setup.
         */
        async function startApp(currentUserId) {
            // Hide the security modal
            const securityModal = document.getElementById('security-modal-backdrop');
            securityModal.style.opacity = '0';
            setTimeout(() => securityModal.style.display = 'none', 500);

            loadFiltersFromLocalStorage(); // Load UI state for filters first

            // Load data from local storage
            const storedData = localStorage.getItem('farmData');
            if (storedData) {
                const parsedData = JSON.parse(storedData);
                // Merge with defaults to ensure new properties are not missed
                window.farmData = { ...window.farmData, ...parsedData };
            } else {
                // If no data, save the initial empty structure
                saveData();
            }


            isAuthReady = true;
            document.getElementById('auth-status').innerHTML = `User ID: <span class="font-medium text-gray-700">${currentUserId}</span> | <span class="text-green-600 font-semibold">Local Mode</span>`;

            renderAllViews();
            changeView('dashboard');

            setTimeout(showApp, 1500);
        }

        function renderAllViews() {
            const { livestock, transactions, production, tasks, inventory } = farmData;
            renderDashboard(livestock, transactions, production, tasks, inventory);
            // Other views are rendered on demand when their tab is clicked or data changes.
        }
        
        // --- UI RENDERING AND LOGIC ---

        /**
         * Changes the active view/tab.
         * @param {string} viewName - The name of the view to switch to.
         */
        window.changeView = function(viewName) {
            document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.remove('active-tab'));
            const activeTab = document.getElementById(`tab-${viewName}`);
            if (activeTab) {
                activeTab.classList.add('active-tab');
            }

            // Update mobile dropdown label
            const dropdownLabel = document.getElementById('nav-dropdown-label');
            if (dropdownLabel && activeTab) {
                dropdownLabel.textContent = activeTab.textContent;
            }

            // Explicitly destroy charts when leaving the finance view to avoid memory leaks
            if (viewName !== 'finance' && viewName !== 'analytics') {
                 if (expenseChart) { expenseChart.destroy(); expenseChart = null; }
                 if (monthlyChart) { monthlyChart.destroy(); monthlyChart = null; }
                 if (incomeChart) { incomeChart.destroy(); incomeChart = null; }
                 if (yoyProductionChart) { yoyProductionChart.destroy(); yoyProductionChart = null; }
                 if (productionTrendChart) { productionTrendChart.destroy(); productionTrendChart = null; }
                 if (livestockCompositionChart) { livestockCompositionChart.destroy(); livestockCompositionChart = null; }
                 if (populationGrowthChart) { populationGrowthChart.destroy(); populationGrowthChart = null; }
                 if (taskStatusChart) { taskStatusChart.destroy(); taskStatusChart = null; }
                 if (profitabilityForecastChart) { profitabilityForecastChart.destroy(); profitabilityForecastChart = null; }
            }

            // Render the content of the view when switching to it
            if (viewName === 'livestock') renderLivestock(farmData.livestock);
            if (viewName === 'finance') renderTransactions(farmData.transactions);
            if (viewName === 'production') renderProduction(farmData.production);
            if (viewName === 'tasks') renderTasks(farmData.tasks);
            if (viewName === 'inventory') renderInventory(farmData.inventory);
            if (viewName === 'animalhub') renderAnimalHub(); // New hub renderer
            if (viewName === 'equipment') renderEquipment(farmData.equipment);
            if (viewName === 'analytics') renderAnalytics();
            if (viewName === 'settings') renderSettings();
            if (viewName === 'dashboard') renderDashboard(farmData.livestock, farmData.transactions, farmData.production, farmData.tasks, farmData.inventory, farmData.equipment);
        }

        /**
         * Navigates to a view with pre-applied filters.
         * @param {string} viewName The name of the view to navigate to.
         * @param {object} filters The filters to apply to that view's state.
         */
        window.navigateTo = function(viewName, filters = {}) {
            // Reset other filters if needed, or merge. For now, we just set.
            viewFilters[viewName] = { ...viewFilters[viewName], ...filters };
            localStorage.setItem('farmViewFilters', JSON.stringify(viewFilters));
            changeView(viewName);
        }

        /**
         * Renders the main Dashboard summary.
         */
        function renderDashboard(livestock, transactions, production, tasks, inventory) {
            const container = document.getElementById('view-dashboard');

            if (!isAuthReady) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500">Initializing local app...</div>`;
                return;
            }
            
            // 0. Overdue Tasks
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day for comparison
            const overdueTasks = tasks.filter(t => t.status !== 'Done' && new Date(t.dueDate) < today);

            let overdueTasksHtml = overdueTasks.map(task => `
                <div class="flex items-center justify-between p-3 bg-red-50/80 rounded-lg border border-red-200/90 hover:bg-red-100/50 transition-colors duration-200">
                    <div class="cursor-pointer flex-grow" onclick="navigateTo('tasks', { isOverdue: true })">
                        <p class="font-semibold text-red-800">${task.title}</p>
                        <p class="text-xs text-red-600 font-bold">Due: ${task.dueDate}</p>
                    </div>
                    <button onclick="navigateTo('tasks', { isOverdue: true })" class="text-xs font-medium text-blue-600 hover:underline">View All</button>
                </div>
            `).join('');

            const overdueTasksCard = overdueTasks.length > 0 ? `
                <div class="bg-red-50/60 p-6 rounded-2xl shadow-md border-2 border-red-200/80 mb-10 cursor-pointer hover:shadow-xl transition-shadow" onclick="navigateTo('tasks', { isOverdue: true })">
                    <h3 class="text-xl font-semibold text-red-700 mb-4 flex items-center"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Overdue Tasks (${overdueTasks.length})</h3>
                    <div class="space-y-3">${overdueTasksHtml}</div>
                </div>` : '';

            // Calculate 30-day production summary
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const recentProduction = production.filter(p => new Date(p.date) >= thirtyDaysAgo);
            
            const productionSummary = recentProduction.reduce((acc, item) => {
                const type = item.type.split(' ')[0];
                const unit = item.type.split('(')[1].replace(')', '');
                acc[type] = acc[type] || { total: 0, unit: unit };
                acc[type].total += parseFloat(item.quantity);
                return acc;
            }, {});

            let productionHtml = Object.entries(productionSummary)
                .map(([type, data]) => `
                    <div class="p-5 bg-card-bg border-l-4 border-secondary-yellow rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200 cursor-pointer" onclick="changeView('production')">
                        <p class="text-sm text-gray-500 font-medium">${type} (Last 30 Days)</p>
                        <p class="text-3xl font-bold text-gray-800 mt-1">${data.total.toLocaleString(undefined, { maximumFractionDigits: 1 })} <span class="text-xl text-secondary-yellow">${data.unit}</span></p>
                    </div>
                `).join('');

            if (productionHtml === '') {
                productionHtml = `
                    <div class="md:col-span-3 p-6 bg-yellow-50/70 rounded-xl text-center border border-yellow-200/80">
                        <p class="text-gray-600 font-medium">No production recorded in the last 30 days.</p>
                        <p class="text-sm text-gray-500 italic">Start logging your yields in the Production tab.</p>
                    </div>
                `;
            }

            // 1. Livestock Summary
            const livestockCounts = livestock.reduce((acc, item) => {
                acc[item.type] = (acc[item.type] || 0) + item.count;
                return acc;
            }, {});
            const totalAnimals = livestock.reduce((sum, item) => sum + item.count, 0);

            let livestockHtml = Object.entries(livestockCounts)
                .map(([type, count]) => `<span class="inline-flex items-center px-3 py-1 text-sm font-medium bg-primary-green/10 text-primary-green-dark rounded-full border border-primary-green/20 cursor-pointer hover:bg-primary-green/20" onclick="changeView('livestock')">${type.charAt(0).toUpperCase() + type.slice(1)}: <span class="font-bold ml-1.5">${count}</span></span>`)
                .join('');
            
            if (livestockHtml === '') {
                livestockHtml = '<p class="text-gray-500 italic">No livestock records added yet.</p>';
            }

            // 2. Financial Summary
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const netProfit = totalIncome - totalExpense;

            const netColor = netProfit >= 0 ? 'text-green-600' : 'text-red-600';
            const netBg = netProfit >= 0 ? 'bg-green-50' : 'bg-red-50';

            // 3. Upcoming Tasks Summary
            const upcomingTasks = tasks
                .filter(t => t.status !== 'Done')
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
                .slice(0, 3); // Get top 3

            let tasksHtml = upcomingTasks.map(task => {
                const isOverdue = new Date(task.dueDate) < new Date(new Date().toDateString()); // Compare date part only
                const dateColor = isOverdue ? 'text-red-600 font-bold' : 'text-gray-600 font-medium';
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50/80 rounded-lg border border-gray-200/90 hover:bg-white transition-colors duration-200 cursor-pointer" onclick="changeView('tasks')">
                        <div>
                            <p class="font-semibold text-gray-800">${task.title}</p>
                            <p class="text-xs ${dateColor}">Due: ${task.dueDate}</p>
                        </div>
                        <span class="text-xs font-medium px-2 py-1 rounded-full ${task.priority === 'High' ? 'bg-red-100 text-red-700' : task.priority === 'Medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700'}">${task.priority}</span>
                    </div>
                `;
            }).join('');

            if (tasksHtml === '') {
                tasksHtml = `<p class="text-center text-gray-500 italic py-4">No upcoming tasks. You're all caught up!</p>`;
            }

            // 4. Upcoming Births Summary
            const upcomingBirths = farmData.breeding
                .filter(b => {
                    const daysRemaining = getDaysDifference(b.expectedDueDate);
                    return b.status === 'In Calf/Farrow' && daysRemaining >= 0 && daysRemaining <= 30;
                })
                .sort((a, b) => new Date(a.expectedDueDate) - new Date(b.expectedDueDate));

            let birthsHtml = upcomingBirths.map(birth => {
                const daysRemaining = getDaysDifference(birth.expectedDueDate);
                const dueText = daysRemaining === 0 ? 'Due Today' : `${daysRemaining} days`;
                const dueColor = daysRemaining <= 7 ? 'text-red-600 font-bold' : 'text-blue-600 font-medium';
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50/80 rounded-lg border border-gray-200/90 hover:bg-white transition-colors duration-200 cursor-pointer" onclick="navigateTo('animalhub')">
                        <div>
                            <p class="font-semibold text-gray-800">${birth.animalId} <span class="text-sm font-normal text-gray-500">(${birth.species})</span></p>
                            <p class="text-xs text-gray-600">Due: ${birth.expectedDueDate}</p>
                        </div>
                        <span class="text-xs ${dueColor}">${dueText}</span>
                    </div>
                `;
            }).join('');

            const upcomingBirthsCard = upcomingBirths.length > 0 ? `
                <div class="lg:col-span-2 bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 cursor-pointer hover:shadow-xl transition-shadow" onclick="navigateTo('animalhub')">
                    <h3 class="text-xl font-semibold text-gray-700 mb-5 flex items-center">Upcoming Births (Next 30 Days)</h3>
                    <div class="space-y-3">${birthsHtml}</div>
                </div>` : '';

            // 4. Low Stock Alerts
            const lowStockItems = inventory.filter(item => 
                item.lowStockThreshold !== null && parseFloat(item.quantity) <= parseFloat(item.lowStockThreshold)
            );

            let lowStockHtml = lowStockItems.map(item => `
                <div class="flex items-center justify-between p-3 bg-red-50/80 rounded-lg border border-red-200/90 hover:bg-red-100/50 transition-colors duration-200">
                    <div class="cursor-pointer flex-grow" onclick="navigateTo('inventory')">
                        <p class="font-semibold text-red-800">${item.name}</p>
                        <p class="text-xs text-red-600">Current: ${item.quantity} ${item.unit} | Alert Level: ${item.lowStockThreshold} ${item.unit}</p>
                    </div>
                    <button onclick="navigateTo('inventory')" class="text-xs font-medium text-blue-600 hover:underline">View All</button>
                </div>
            `).join('');

            const lowStockCard = lowStockItems.length > 0 ? `
                <div class="bg-red-50/60 p-6 rounded-2xl shadow-md border-2 border-red-200/80 mb-10 cursor-pointer hover:shadow-xl transition-shadow" onclick="navigateTo('inventory')">
                    <h3 class="text-xl font-semibold text-red-700 mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Low Stock Alerts
                    </h3>
                    <div class="space-y-3">
                        ${lowStockHtml}
                    </div>
                </div>
            ` : '';


            container.innerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-8">Farm Dashboard</h2>
                
                ${overdueTasksCard}
                ${lowStockCard}

                <!-- Production Summary Card -->
                <div class="bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 mb-10">
                    <h3 class="text-xl font-semibold text-gray-700 mb-5 flex items-center">
                        <svg class="w-6 h-6 mr-3 text-secondary-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3 .895-3 2 1.343 2 3 2m0-8V9a1 1 0 00-1-1h-2a1 1 0 00-1 1v1m0 4v1a1 1 0 001 1h2a1 1 0 001-1v-1m-4 0h4"></path></svg>
                        Production & Yield Snapshot
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        ${productionHtml}
                    </div>
                </div>

                <!-- Multi-Card Section -->
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-10 mb-10">
                    <!-- Livestock Summary Card (lg:col-span-3) -->
                    <div class="lg:col-span-3 bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 cursor-pointer hover:shadow-xl transition-shadow" onclick="changeView('livestock')">
                        <h3 class="text-xl font-semibold text-gray-700 mb-5 flex items-center">
                            <svg class="w-6 h-6 mr-3 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-4m0 0l-3 3m3-3l3 3m0 0V9a2 2 0 00-2-2H5a2 2 0 00-2 2v8l3-3m3-3v4m0 0l-3-3m3 3l3-3m0 0V9a2 2 0 012-2h4a2 2 0 012 2v8l-3-3m-3 3v-4"></path></svg>
                            Livestock Overview (All Time)
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="p-5 bg-primary-green/10 rounded-lg border-l-4 border-primary-green shadow-sm hover:bg-primary-green/20">
                                <p class="text-sm text-gray-600 font-medium">Total Head Count</p>
                                <p class="text-3xl font-bold text-gray-800 mt-1">${totalAnimals.toLocaleString()}</p>
                            </div>
                            <div class="p-5 bg-primary-green/10 rounded-lg border-l-4 border-primary-green shadow-sm hover:bg-primary-green/20">
                                <p class="text-sm text-gray-600 font-medium">Unique Types Tracked</p>
                                <p class="text-3xl font-bold text-gray-800 mt-1">${Object.keys(livestockCounts).length}</p>
                            </div>
                        </div>
                        <p class="font-semibold text-gray-700 mb-3">Detailed Counts:</p>
                        <div class="flex flex-wrap gap-3">
                            ${livestockHtml}
                        </div>
                    </div>

                    <!-- Upcoming Tasks Card (lg:col-span-2) -->
                    <div class="lg:col-span-2 bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 cursor-pointer hover:shadow-xl transition-shadow" onclick="navigateTo('tasks', { isOverdue: false })">
                        <h3 class="text-xl font-semibold text-gray-700 mb-5 flex items-center">
                            <svg class="w-6 h-6 mr-3 text-secondary-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                            Upcoming Tasks
                        </h3>
                        <div class="space-y-3">
                            ${tasksHtml}
                        </div>
                    </div>
                </div>

                ${upcomingBirthsCard ? `<div class="grid grid-cols-1 lg:grid-cols-2 gap-10">${upcomingBirthsCard}</div>` : ''}

                <!-- Finance Summary Card -->
                <div class="bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 mt-10">
                    <h3 class="text-xl font-semibold text-gray-700 mb-5 flex items-center">
                        <svg class="w-6 h-6 mr-3 text-secondary-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        Financial Performance (All Time)
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        <div class="p-5 bg-green-50 rounded-lg border-l-4 border-green-500 shadow-sm cursor-pointer hover:bg-green-100" onclick="navigateTo('finance', { type: 'income', dateRange: 'all' })">
                            <p class="text-sm text-green-700 font-medium">Total Income</p>
                            <p class="text-2xl font-bold text-green-600 mt-1">KSh ${totalIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                        </div>
                        <div class="p-5 bg-red-50 rounded-lg border-l-4 border-red-500 shadow-sm cursor-pointer hover:bg-red-100" onclick="navigateTo('finance', { type: 'expense', dateRange: 'all' })">
                            <p class="text-sm text-red-700 font-medium">Total Expenses</p>
                            <p class="text-2xl font-bold text-red-600 mt-1">KSh ${totalExpense.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                        </div>
                        <div class="p-5 ${netBg} rounded-lg border-l-4 ${netProfit >= 0 ? 'border-green-500' : 'border-red-500'} shadow-sm cursor-pointer hover:bg-gray-100" onclick="navigateTo('finance', { type: 'all', dateRange: 'all' })">
                            <p class="text-sm text-gray-700 font-medium">Net Profit/Loss</p>
                            <p class="text-2xl font-bold ${netColor} mt-1">KSh ${netProfit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the Livestock Composition doughnut chart.
         */
        function renderLivestockCompositionChart(livestockData) {
            if (livestockCompositionChart) livestockCompositionChart.destroy();
            const ctx = document.getElementById('livestock-composition-chart')?.getContext('2d');
            if (!ctx) return;

            const counts = livestockData.reduce((acc, item) => {
                acc[item.type] = (acc[item.type] || 0) + item.count;
                return acc;
            }, {});

            const labels = Object.keys(counts);
            const data = Object.values(counts);

            if (data.length === 0) {
                ctx.canvas.parentNode.innerHTML = '<p class="text-center text-gray-500 py-16">No livestock data to display.</p>';
                return;
            }

            const chartColors = ['#059669', '#f59e0b', '#3b82f6', '#ef4444', '#8b5cf6', '#10b981', '#fbbf24', '#60a5fa'];

            livestockCompositionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        data: data,
                        backgroundColor: labels.map((_, i) => chartColors[i % chartColors.length]),
                        borderColor: '#ffffff',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: (c) => ` ${c.label}: ${c.parsed.toLocaleString()} head`
                            }
                        }
                    }
                }
            });
        }

        /**
         * Renders the population growth chart.
         */
        function renderPopulationGrowthChart(livestockData) {
            if (populationGrowthChart) populationGrowthChart.destroy();
            const ctx = document.getElementById('population-growth-chart')?.getContext('2d');
            if (!ctx) return;

            const monthlyData = {};
            const today = new Date();

            for (let i = 0; i < 12; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleString('en-US', { month: 'short', year: 'numeric' });
                monthlyData[key] = { label, acquired: 0 };
            }

            livestockData.forEach(item => {
                const acqDate = new Date(item.date);
                const key = `${acqDate.getFullYear()}-${String(acqDate.getMonth() + 1).padStart(2, '0')}`;
                if (monthlyData[key]) {
                    monthlyData[key].acquired += item.count;
                }
            });

            const sortedData = Object.values(monthlyData).sort((a, b) => new Date(a.label) - new Date(b.label));
            const labels = sortedData.map(d => d.label);
            const acquiredData = sortedData.map(d => d.acquired);

            populationGrowthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Acquired / Born',
                        data: acquiredData,
                        backgroundColor: '#34d399', // Emerald 400
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { grid: { display: false } }, y: { beginAtZero: true, title: { display: true, text: 'Head Count' } } },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => ` ${c.dataset.label}: ${c.parsed.y.toLocaleString()}` } } }
                }
            });
        }

        /**
         * Renders the Livestock Management view. (Unchanged)
         */
        function renderLivestock(livestock) {
            const container = document.getElementById('view-livestock');
            const sortedLivestock = livestock.slice().sort((a, b) => a.type.localeCompare(b.type)); // Sort by type
            
            container.innerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-8">Livestock Management</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Add Livestock Form -->
                    <div class="lg:col-span-1 bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 h-fit">
                        <h3 class="text-xl font-bold mb-5 border-b pb-3 text-gray-800">Log New Head/Group</h3>
                        <form id="add-livestock-form" onsubmit="event.preventDefault(); handleAddLivestock();">
                            <div class="mb-4">
                                <label for="livestock-type" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                <select id="livestock-type" required class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition">
                                    ${farmData.livestockTypes.map(t => `<option value="${t}">${t.charAt(0).toUpperCase() + t.slice(1)}</option>`).join('')}
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="livestock-count" class="block text-sm font-medium text-gray-700 mb-1">Quantity/Count</label>
                                <input type="number" id="livestock-count" required min="1" value="1" class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition">
                            </div>
                            <div class="mb-4">
                                <label for="livestock-date" class="block text-sm font-medium text-gray-700 mb-1">Acquisition/Birth Date</label>
                                <input type="date" id="livestock-date" required class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition" value="${new Date().toISOString().substring(0, 10)}">
                            </div>
                            <div class="mb-6">
                                <label for="livestock-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes (e.g., breed, source)</label>
                                <textarea id="livestock-notes" rows="3" class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-primary-green text-white py-3 rounded-lg font-bold hover:bg-primary-green-dark transition shadow-md shadow-primary-green/40 transform hover:scale-[1.01]">Add Record</button>
                            <p id="livestock-msg" class="text-center mt-3 text-sm font-medium"></p>
                        </form>
                    </div>

                    <!-- Livestock List Table -->
                    <div class="lg:col-span-2">
                        <div class="flex justify-between items-center mb-5 pb-3 border-b">
                            <h3 class="text-xl font-bold text-gray-800">Current Headcount Records (${sortedLivestock.length})</h3>
                            <div class="flex items-center space-x-2">
                                <button onclick="handleExportPdf('livestock')" class="px-3 py-1.5 text-xs font-medium bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center space-x-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>PDF</span></button>
                                <button onclick="exportToCsv(farmData.livestock, 'livestock-records.csv')" class="px-3 py-1.5 text-xs font-medium bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center space-x-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    <span>CSV</span>
                                </button>
                            </div>
                        </div>
                        <div class="bg-card-bg rounded-2xl shadow-lg overflow-hidden border border-gray-200/80">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Type</th>
                                            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Count</th>
                                            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                                            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Notes</th>
                                            <th class="px-5 py-3 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-100">
                                        ${sortedLivestock.length > 0 ? sortedLivestock.map(item => `
                                            <tr class="hover:bg-gray-50/80 transition duration-150">
                                                <td class="px-5 py-3 whitespace-nowrap text-sm font-semibold text-gray-800">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</td>
                                                <td class="px-5 py-3 whitespace-nowrap text-sm text-gray-700 font-mono">${item.count.toLocaleString()}</td>
                                                <td class="px-5 py-3 whitespace-nowrap text-sm text-gray-600">${item.date}</td>
                                                <td class="px-5 py-3 text-sm text-gray-500 max-w-xs truncate">${item.notes || 'N/A'}</td>
                                                <td class="px-5 py-3 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                                    <button onclick="window.openEditModal('${item.id}', 'livestock')" class="text-blue-600 hover:text-blue-800 transition p-1.5 rounded-full hover:bg-blue-100" title="Edit">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-3l-4 4V14h3l4-4M16 5l3 3m-8 10h.01"></path></svg>
                                                    </button>
                                                    <button onclick="window.confirmDelete('${item.id}', 'livestock')" class="text-red-600 hover:text-red-800 transition p-1.5 rounded-full hover:bg-red-100" title="Delete">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('') : `
                                            <tr><td colspan="5" class="px-5 py-10 text-center text-gray-500 italic">No livestock records found. Use the form on the left to add your first entry.</td></tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Renders the detailed transaction list HTML.
         */
        function renderTransactionList(transactions) {
            if (transactions.length === 0) {
                return `<p class="text-center text-gray-500 italic py-10">No transactions match the current filter criteria.</p>`;
            }
            
            return transactions.map(t => {
                const isIncome = t.type === 'income';
                const colorClass = isIncome ? 'text-green-700 bg-green-100 border-green-300' : 'text-red-700 bg-red-100 border-red-300';
                const sign = isIncome ? '+' : '-';
                return `
                    <div class="flex justify-between items-center border-b border-gray-100 py-4 last:border-b-0 hover:bg-gray-50/80 transition duration-150 rounded-lg px-2 -mx-2">
                        <div class="flex flex-col flex-1 min-w-0 pr-4">
                            <span class="text-base font-semibold text-gray-800 truncate">${t.category}</span>
                            <span class="text-xs text-gray-500 mt-0.5">${t.date} | ${t.notes || 'No detailed notes'}</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="font-bold text-sm ${colorClass} px-3 py-1.5 rounded-full min-w-[130px] text-center border font-mono">${sign}KSh ${parseFloat(t.amount).toFixed(2).toLocaleString()}</span>
                            <button onclick="window.openEditModal('${t.id}', 'transactions')" class="text-blue-600 hover:text-blue-800 transition p-1.5 rounded-full hover:bg-blue-100" title="Edit">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-3l-4 4V14h3l4-4M16 5l3 3m-8 10h.01"></path></svg>
                            </button>
                            <button onclick="window.confirmDelete('${t.id}', 'transactions')" class="text-red-600 hover:text-red-800 transition p-1.5 rounded-full hover:bg-red-100" title="Delete">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Calculates and renders the financial summary metrics (Income, Expense, Net).
         */
        function renderFinancialSummary(transactions) {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const netProfit = totalIncome - totalExpense;

            const netColor = netProfit >= 0 ? 'text-green-600' : 'text-red-600';
            const netBg = netProfit >= 0 ? 'bg-green-50' : 'bg-red-50';
            const netBorder = netProfit >= 0 ? 'border-green-500' : 'border-red-500';

            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center mt-4">
                    <div class="p-5 bg-green-50 rounded-lg border-l-4 border-green-500 shadow-sm">
                        <p class="text-sm text-green-700 font-medium">Total Income</p>
                        <p class="text-2xl font-bold text-green-600 mt-1">KSh ${totalIncome.toFixed(2).toLocaleString()}</p>
                    </div>
                    <div class="p-5 bg-red-50 rounded-lg border-l-4 border-red-500 shadow-sm">
                        <p class="text-sm text-red-700 font-medium">Total Expenses</p>
                        <p class="text-2xl font-bold text-red-600 mt-1">KSh ${totalExpense.toFixed(2).toLocaleString()}</p>
                    </div>
                    <div class="p-5 ${netBg} rounded-lg border-l-4 ${netBorder} shadow-sm">
                        <p class="text-sm text-gray-700 font-medium">Net Profit/Loss</p>
                        <p class="text-2xl font-bold ${netColor} mt-1">KSh ${netProfit.toFixed(2).toLocaleString()}</p>
                    </div>
                </div>
            `;
        }

        /**
         * Applies filters to the raw transactions data.
         */
        function filterTransactions(transactions, filters) {
            let filtered = [...transactions];

            // Filter by Type
            if (filters.type !== 'all') {
                filtered = filtered.filter(t => t.type === filters.type);
            }
            
            // Filter by Category (future use)
            if (filters.category !== 'all') {
                filtered = filtered.filter(t => t.category === filters.category);
            }

            // Filter by Date Range
            if (filters.dateRange !== 'all') {
                let startDate, endDate;
                const now = new Date();
                now.setHours(0, 0, 0, 0); // Normalize time

                if (filters.dateRange === '30d') {
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 30);
                } else if (filters.dateRange === '90d') {
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 90);
                } else if (filters.dateRange === 'custom') {
                    if (filters.startDate) {
                        startDate = new Date(filters.startDate);
                    }
                    if (filters.endDate) {
                        endDate = new Date(filters.endDate);
                        endDate.setDate(endDate.getDate() + 1); // Include the entire end date
                    }
                }

                filtered = filtered.filter(t => {
                    const tDate = new Date(t.date);
                    
                    let passedStart = true;
                    if (startDate) {
                        passedStart = tDate >= startDate;
                    }

                    let passedEnd = true;
                    if (endDate) {
                        passedEnd = tDate < endDate;
                    }

                    return passedStart && passedEnd;
                });
            }

            return filtered;
        }

        /**
         * Updates the filter state and re-renders the finance view.
         */
        window.updateFinanceFilter = function(key, value) {
            viewFilters.finance[key] = value;
            
            // Handle custom date visibility
            const startContainer = document.getElementById('custom-date-start-container');
            const endContainer = document.getElementById('custom-date-end-container');
            const startDateInput = document.getElementById('filter-start-date');
            const endDateInput = document.getElementById('filter-end-date');


            if (key === 'dateRange') {
                if (value === 'custom') {
                    startContainer?.classList.remove('hidden');
                    endContainer?.classList.remove('hidden');
                    // Reset custom date values if they were empty
                    if (startDateInput && !viewFilters.finance.startDate) viewFilters.finance.startDate = startDateInput.value;
                    if (endDateInput && !financeFilters.finance.endDate) viewFilters.finance.endDate = endDateInput.value;
                } else {
                    startContainer?.classList.add('hidden');
                    endContainer?.classList.add('hidden');
                    // Clear custom dates if switching away
                    viewFilters.finance.startDate = null;
                    viewFilters.finance.endDate = null;
                }
            }
            
            // If the inputs exist, ensure they reflect the latest state before re-render
            if (key === 'startDate') viewFilters.finance.startDate = value;
            if (key === 'endDate') viewFilters.finance.endDate = value;

            // Persist the filter state to localStorage
            localStorage.setItem('farmViewFilters', JSON.stringify(viewFilters));


            // Re-render the finance view with new filters applied
            renderTransactions(farmData.transactions);
        }

        /**
         * Renders the Chart.js visualizations.
         */
        function renderCharts(transactions) {
            // 1. Prepare Expense Pie Chart Data
            const expenses = transactions.filter(t => t.type === 'expense');
            const expenseData = expenses.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + parseFloat(t.amount);
                return acc;
            }, {});

            const expenseLabels = Object.keys(expenseData);
            const expenseAmounts = Object.values(expenseData);
            
            const categoryColors = [
                '#059669', '#10b981', '#34d399', '#f59e0b', '#fbbf24', 
                '#f87171', '#ef4444', '#a855f7', '#8b5cf6', '#3b82f6', '#4f46e5', '#ec4899'
            ];
            
            // Destroy previous instance
            if (expenseChart) expenseChart.destroy();
            if (incomeChart) incomeChart.destroy();

            const pieCtx = document.getElementById('expense-pie-chart')?.getContext('2d');
            if (pieCtx && expenseAmounts.length > 0) {
                expenseChart = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: expenseLabels,
                        datasets: [{
                            data: expenseAmounts,
                            backgroundColor: expenseLabels.map((_, i) => categoryColors[i % categoryColors.length]),
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: '#1f2937',
                                    font: { family: 'Inter', size: 10 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += 'KSh ' + context.parsed.toFixed(2).toLocaleString();
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } else if (pieCtx) {
                 pieCtx.canvas.parentNode.innerHTML = '<p class="text-center text-gray-500 py-16">No expenses in this period to chart.</p>';
            }

            // 2. Prepare Income Pie Chart Data
            const incomes = transactions.filter(t => t.type === 'income');
            const incomeData = incomes.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + parseFloat(t.amount);
                return acc;
            }, {});

            const incomeLabels = Object.keys(incomeData);
            const incomeAmounts = Object.values(incomeData);

            const incomeCtx = document.getElementById('income-pie-chart')?.getContext('2d');
            if (incomeCtx && incomeAmounts.length > 0) {
                incomeChart = new Chart(incomeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: incomeLabels,
                        datasets: [{
                            data: incomeAmounts,
                            backgroundColor: incomeLabels.map((_, i) => categoryColors[i % categoryColors.length]),
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: '#1f2937',
                                    font: { family: 'Inter', size: 10 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        label += 'KSh ' + context.parsed.toFixed(2).toLocaleString();
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } else if (incomeCtx) {
                incomeCtx.canvas.parentNode.innerHTML = '<p class="text-center text-gray-500 py-16">No income in this period to chart.</p>';
            }

            // 3. Prepare Profitability Trend Line Data (last 12 months)
            const monthlyData = {};
            const today = new Date();
            
            for (let i = 0; i < 12; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleString('en-US', { month: 'short', year: 'numeric' });
                monthlyData[key] = { label, income: 0, expense: 0, net: 0 };
            }

            // Filter transactions that fall within the 6 month window
            const twelveMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 11, 1);
            const recentTransactions = transactions.filter(t => new Date(t.date) >= twelveMonthsAgo);
            
            recentTransactions.forEach(t => {
                const tDate = new Date(t.date);
                const key = `${tDate.getFullYear()}-${String(tDate.getMonth() + 1).padStart(2, '0')}`;

                if (monthlyData[key]) {
                    const amount = parseFloat(t.amount);
                    if (t.type === 'income') {
                        monthlyData[key].income += amount;
                    } else if (t.type === 'expense') {
                        monthlyData[key].expense += amount;
                    }
                }
            });

            // Calculate net and sort chronologically
            const sortedMonthlyData = Object.values(monthlyData)
                .map(item => ({ ...item, net: item.income - item.expense }))
                .sort((a, b) => {
                    // Simple chronological sort based on label for accurate display
                    const monthYearA = a.label.split(' ');
                    const monthYearB = b.label.split(' ');
                    const dateA = new Date(`${monthYearA[0]} 1, ${monthYearA[1]}`);
                    const dateB = new Date(`${monthYearB[0]} 1, ${monthYearB[1]}`);
                    return dateA - dateB;
                });

            const monthlyLabels = sortedMonthlyData.map(d => d.label);
            const monthlyIncome = sortedMonthlyData.map(d => d.income);
            const monthlyExpense = sortedMonthlyData.map(d => d.expense);
            const monthlyNet = sortedMonthlyData.map(d => d.net);

            // Destroy previous instance
            if (monthlyChart) monthlyChart.destroy();

            const barCtx = document.getElementById('monthly-chart')?.getContext('2d');
            if (barCtx && (monthlyIncome.some(v => v > 0) || monthlyExpense.some(v => v > 0))) {
                 monthlyChart = new Chart(barCtx, {
                    type: 'line',
                    data: {
                        labels: monthlyLabels,
                        datasets: [
                            {
                                label: 'Income',
                                data: monthlyIncome,
                                borderColor: '#10b981',
                                backgroundColor: '#10b981',
                                tension: 0.3,
                            },
                            {
                                label: 'Expense',
                                data: monthlyExpense,
                                borderColor: '#f87171',
                                backgroundColor: '#f87171',
                                tension: 0.3,
                            },
                            {
                                label: 'Net Profit',
                                data: monthlyNet,
                                borderColor: '#3b82f6',
                                backgroundColor: '#3b82f6',
                                tension: 0.3,
                                borderDash: [5, 5], // Dashed line for net
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        },
                        scales: {
                            x: { grid: { display: false } },
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Amount (KSh)', color: '#4b5563' }
                            }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += 'KSh ' + context.parsed.y.toFixed(2).toLocaleString();
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } else if (barCtx) {
                 barCtx.canvas.parentNode.innerHTML = '<p class="text-center text-gray-500 py-16">No transactions in the last 12 months to chart.</p>';
            }
        }

        /**
         * Renders the Profitability Forecast chart using linear regression.
         */
        function renderProfitabilityForecastChart(transactions) {
            if (profitabilityForecastChart) profitabilityForecastChart.destroy();
            const ctx = document.getElementById('profitability-forecast-chart')?.getContext('2d');
            if (!ctx) return;

            // 1. Calculate historical monthly net profit (last 12 months)
            const monthlyData = {};
            const today = new Date();
            for (let i = 0; i < 12; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[key] = { label: d.toLocaleString('en-US', { month: 'short', year: 'numeric' }), net: 0 };
            }

            const twelveMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 11, 1);
            transactions.filter(t => new Date(t.date) >= twelveMonthsAgo).forEach(t => {
                const tDate = new Date(t.date);
                const key = `${tDate.getFullYear()}-${String(tDate.getMonth() + 1).padStart(2, '0')}`;
                if (monthlyData[key]) {
                    monthlyData[key].net += t.type === 'income' ? parseFloat(t.amount) : -parseFloat(t.amount);
                }
            });

            const sortedHistoricalData = Object.values(monthlyData).sort((a, b) => new Date(a.label) - new Date(b.label));
            const historicalNet = sortedHistoricalData.map(d => d.net);

            if (historicalNet.filter(v => v !== 0).length < 2) {
                ctx.canvas.parentNode.innerHTML = '<p class="text-center text-gray-500 py-16">Not enough historical data to generate a forecast. At least two months of transactions are needed.</p>';
                return;
            }

            // 2. Perform linear regression
            const n = historicalNet.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            historicalNet.forEach((y, x) => {
                sumX += x; sumY += y; sumXY += x * y; sumX2 += x * x;
            });
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // 3. Generate forecast data for the next 6 months
            const forecastData = Array(12).fill(null); // 12 historical points
            for (let i = 0; i < 7; i++) { // 6 future points + connecting point
                forecastData.push(slope * (11 + i) + intercept);
            }

            // 4. Prepare labels for the next 6 months
            const futureLabels = [];
            for (let i = 1; i <= 6; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() + i, 1);
                futureLabels.push(d.toLocaleString('en-US', { month: 'short', year: 'numeric' }));
            }
            const allLabels = [...sortedHistoricalData.map(d => d.label), ...futureLabels];

            // 5. Render the chart
            profitabilityForecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allLabels,
                    datasets: [
                        { label: 'Historical Net Profit', data: historicalNet, borderColor: '#3b82f6', tension: 0.1, fill: false },
                        { label: 'Forecasted Trend', data: forecastData, borderColor: '#f59e0b', borderDash: [5, 5], tension: 0.1, fill: false }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { grid: { display: false } }, y: { title: { display: true, text: 'Net Profit (KSh)' } } },
                    plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } }
                }
            });
        }


        /**
         * Renders the Finance (Inputs/Sales) view. (Updated)
         */
        function renderTransactions(transactions) {
            const container = document.getElementById('view-finance');
            
            // --- 1. FILTER DATA ---
            const filteredTransactions = filterTransactions(transactions, viewFilters.finance);

            // Set default date values if filter is custom but dates are null
            const defaultStartDate = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().substring(0, 10);
            const defaultEndDate = new Date().toISOString().substring(0, 10);

            if (viewFilters.finance.dateRange === 'custom' && !viewFilters.finance.startDate) {
                viewFilters.finance.startDate = defaultStartDate;
            }
            if (viewFilters.finance.dateRange === 'custom' && !viewFilters.finance.endDate) {
                viewFilters.finance.endDate = defaultEndDate;
            }


            // --- 2. RENDER THE COMPLETE VIEW STRUCTURE ---
            container.innerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-8">Finance Tracking & Analytics</h2>
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                    
                    <!-- Add Transaction Form (lg:col-span-1) -->
                    <div class="lg:col-span-1 bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 h-fit">
                        <h3 class="text-xl font-bold mb-5 border-b pb-3 text-gray-800">Record New Transaction</h3>
                        <form id="add-transaction-form" onsubmit="event.preventDefault(); handleAddTransaction();">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                <select id="transaction-type" onchange="updateTransactionCategories('transaction-category')" required class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition">
                                    <option value="expense">Expense (Input)</option>
                                    <option value="income">Income (Sale)</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="transaction-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                <select id="transaction-category" required class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="transaction-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount (KSh)</label>
                                <input type="number" id="transaction-amount" required min="0.01" step="0.01" placeholder="e.g., 500.00" class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition">
                            </div>
                            <div class="mb-4">
                                <label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="transaction-date" required class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition" value="${new Date().toISOString().substring(0, 10)}">
                            </div>
                            <div class="mb-6">
                                <label for="transaction-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes (e.g., supplier, item quantity)</label>
                                <textarea id="transaction-notes" rows="3" class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-primary-green text-white py-3 rounded-lg font-bold hover:bg-primary-green-dark transition shadow-md shadow-primary-green/40 transform hover:scale-[1.01]">Record Transaction</button>
                            <p id="transaction-msg" class="text-center mt-3 text-sm font-medium"></p>
                        </form>
                    </div>

                    <!-- Financial Analytics Panel (lg:col-span-3) -->
                    <div class="lg:col-span-3">
                        <div class="bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80">
                            <h3 class="text-xl font-bold mb-5 pb-3 border-b text-gray-800">Financial Overview</h3>
                            
                            <!-- Filter Controls -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div>
                                    <label for="filter-type" class="block text-xs font-medium text-gray-600 mb-1">Type Filter</label>
                                    <select id="filter-type" onchange="updateFinanceFilter('type', this.value)" class="input-focus w-full p-2 border border-gray-300 rounded-lg text-sm">
                                        <option value="all">All Transactions</option>
                                        <option value="income">Income Only</option>
                                        <option value="expense">Expense Only</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filter-date-range" class="block text-xs font-medium text-gray-600 mb-1">Time Period</label>
                                    <select id="filter-date-range" onchange="updateFinanceFilter('dateRange', this.value)" class="input-focus w-full p-2 border border-gray-300 rounded-lg text-sm">
                                        <option value="all">All Time</option>
                                        <option value="30d">Last 30 Days</option>
                                        <option value="90d">Last 90 Days</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>
                                <div id="custom-date-start-container" class="${viewFilters.finance.dateRange === 'custom' ? '' : 'hidden'}">
                                    <label for="filter-start-date" class="block text-xs font-medium text-gray-600 mb-1">Start Date</label>
                                    <input type="date" id="filter-start-date" onchange="updateFinanceFilter('startDate', this.value)" class="input-focus w-full p-2 border border-gray-300 rounded-lg text-sm" value="${viewFilters.finance.startDate || defaultStartDate}">
                                </div>
                                <div id="custom-date-end-container" class="${viewFilters.finance.dateRange === 'custom' ? '' : 'hidden'}">
                                    <label for="filter-end-date" class="block text-xs font-medium text-gray-600 mb-1">End Date</label>
                                    <input type="date" id="filter-end-date" onchange="updateFinanceFilter('endDate', this.value)" class="input-focus w-full p-2 border border-gray-300 rounded-lg text-sm" value="${viewFilters.finance.endDate || defaultEndDate}">
                                </div>
                            </div>

                            <!-- Summary Metrics -->
                            ${renderFinancialSummary(filteredTransactions)}

                        </div>
                    </div>
                </div>

                <!-- Transaction History List (Below Analytics) -->
                <div class="mt-8">
                    <div class="flex justify-between items-center mb-5 pb-3 border-b">
                        <h3 class="text-xl font-bold text-gray-800">Transaction History (${filteredTransactions.length} Filtered Records)</h3>
                        <button onclick="handleExportPdf('transactions')" class="px-3 py-1.5 text-xs font-medium bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center space-x-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Export PDF</span></button>
                    </div>
                    <div id="transaction-list-container-outer" class="bg-card-bg p-6 rounded-2xl shadow-lg border border-gray-200/80">
                        <div id="transaction-list-container" class="h-[400px] overflow-y-auto">
                            <!-- The renderTransactionList function is called here, which now uses the filtered data -->
                            ${renderTransactionList(filteredTransactions)}
                        </div>
                    </div>
                </div>
            `;

            // Initialize/Update categories dropdown for the ADD form
            updateTransactionCategories('transaction-category'); 
            
            // Set filter control values based on state
            document.getElementById('filter-type').value = viewFilters.finance.type;
            document.getElementById('filter-date-range').value = viewFilters.finance.dateRange;

            // Note: Charts are now rendered in the Analytics tab
        }
        
        /**
         * Renders the Year-over-Year production comparison chart.
         */
        function renderYoYProductionChart(productionData, selectedType) {
            if (yoyProductionChart) yoyProductionChart.destroy();

            const ctx = document.getElementById('yoy-production-chart')?.getContext('2d');
            if (!ctx) return;

            const now = new Date();
            const currentYear = now.getFullYear();
            const previousYear = currentYear - 1;

            const currentYearData = Array(12).fill(0);
            const previousYearData = Array(12).fill(0);

            productionData
                .filter(p => p.type === selectedType)
                .forEach(p => {
                    const recordDate = new Date(p.date);
                    const year = recordDate.getFullYear();
                    const month = recordDate.getMonth(); // 0-11

                    if (year === currentYear) {
                        currentYearData[month] += parseFloat(p.quantity);
                    } else if (year === previousYear) {
                        previousYearData[month] += parseFloat(p.quantity);
                    }
                });

            const hasData = currentYearData.some(d => d > 0) || previousYearData.some(d => d > 0);
            if (!hasData) {
                ctx.canvas.parentNode.innerHTML = `<p class="text-center text-gray-500 py-16">No data for "${selectedType}" in the last two years.</p>`;
                return;
            }

            yoyProductionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [
                        {
                            label: `${previousYear}`,
                            data: previousYearData,
                            backgroundColor: '#a5b4fc', // Indigo 300
                            borderRadius: 4,
                        },
                        {
                            label: `${currentYear}`,
                            data: currentYearData,
                            backgroundColor: '#4f46e5', // Indigo 600
                            borderRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { grid: { display: false } }, y: { beginAtZero: true } },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        /**
         * Renders the multi-product production trend line chart.
         */
        function renderProductionTrendChart(productionData, selectedTypes) {
            if (productionTrendChart) productionTrendChart.destroy();

            const ctx = document.getElementById('production-trend-chart')?.getContext('2d');
            if (!ctx) return;

            const chartColors = ['#059669', '#f59e0b', '#3b82f6', '#ef4444', '#8b5cf6'];
            const monthlyData = {};
            const today = new Date();

            for (let i = 0; i < 12; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleString('en-US', { month: 'short', year: 'numeric' });
                monthlyData[key] = { label };
                selectedTypes.forEach(type => monthlyData[key][type] = 0);
            }

            const twelveMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 11, 1);
            productionData
                .filter(p => new Date(p.date) >= twelveMonthsAgo && selectedTypes.includes(p.type))
                .forEach(p => {
                    const tDate = new Date(p.date);
                    const key = `${tDate.getFullYear()}-${String(tDate.getMonth() + 1).padStart(2, '0')}`;
                    if (monthlyData[key]) {
                        monthlyData[key][p.type] += parseFloat(p.quantity);
                    }
                });

            const sortedMonthlyData = Object.values(monthlyData).sort((a, b) => new Date(a.label) - new Date(b.label));
            const labels = sortedMonthlyData.map(d => d.label);

            const datasets = selectedTypes.map((type, i) => ({
                label: type,
                data: sortedMonthlyData.map(d => d[type]),
                borderColor: chartColors[i % chartColors.length] + '99', // Add some transparency
                backgroundColor: chartColors[i % chartColors.length] + '20', // Lighter fill
                tension: 0.3,
                fill: true,
                pointBackgroundColor: chartColors[i % chartColors.length],
                pointRadius: 4,
                pointHoverRadius: 6,
                borderWidth: 2,

            }));

            const hasData = datasets.some(ds => ds.data.some(d => d > 0));
            if (!hasData) {
                // Instead of destroying the canvas, show a message in the parent.
                const parent = ctx.canvas.parentNode;
                parent.querySelector('#production-trend-no-data')?.classList.remove('hidden');
                ctx.canvas.classList.add('hidden');
                return;
            }

            productionTrendChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { 
                        mode: 'index', 
                        intersect: false 
                    },
                    scales: { x: { grid: { display: false } }, y: { beginAtZero: true, title: { display: true, text: 'Quantity' } } },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        window.handleProductionChartUpdate = function() {
            // For YoY Chart
            const yoySelect = document.getElementById('yoy-product-select');
            if (yoySelect) {
                renderYoYProductionChart(farmData.production, yoySelect.value);
            }
            // For Trend Chart
            const trendCheckboxes = document.querySelectorAll('#trend-product-select input[type="checkbox"]:checked');
            const selectedTrendTypes = Array.from(trendCheckboxes).map(cb => cb.value);
            renderProductionTrendChart(farmData.production, selectedTrendTypes);
        }

        /**
         * Renders the Production Tracking view.
         */
        function renderProduction(production) {
            const container = document.getElementById('view-production');
            const sortedProduction = production.slice().sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending
            const uniqueProductionTypes = [...new Set(production.map(p => p.type))];
            const defaultYoYType = farmData.productionTypes[0];
            
            container.innerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-8">Production Tracking</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- Add Production Form -->
                    <div class="lg:col-span-1 bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 h-fit">
                        <h3 class="text-xl font-bold mb-5 border-b pb-3 text-gray-800">Log New Harvest/Yield</h3>
                        <form id="add-production-form" onsubmit="event.preventDefault(); handleAddProduction();">
                            <div class="mb-4">
                                <label for="production-type" class="block text-sm font-medium text-gray-700 mb-1">Product Type</label>
                                <select id="production-type" required class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition">
                                    ${farmData.productionTypes.map(t => `<option value="${t}">${t}</option>`).join('')}
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="production-quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                <input type="number" id="production-quantity" required min="0.1" step="0.1" placeholder="e.g., 50.5" class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition">
                            </div>
                            <div class="mb-4">
                                <label for="production-date" class="block text-sm font-medium text-gray-700 mb-1">Harvest Date</label>
                                <input type="date" id="production-date" required class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition" value="${new Date().toISOString().substring(0, 10)}">
                            </div>
                            <div class="mb-6">
                                <label for="production-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes (e.g., area harvested, specific herd)</label>
                                <textarea id="production-notes" rows="3" class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-primary-green text-white py-3 rounded-lg font-bold hover:bg-primary-green-dark transition shadow-md shadow-primary-green/40 transform hover:scale-[1.01]">Log Production</button>
                            <p id="production-msg" class="text-center mt-3 text-sm font-medium"></p>
                        </form>
                    </div>

                    <!-- Production Analytics -->
                    <div class="lg:col-span-2 space-y-8">
                    </div>
                </div>

                <div class="mt-12">
                    <!-- Production History List -->
                        <div class="flex justify-between items-center mb-5 pb-3 border-b">
                            <h3 class="text-xl font-bold text-gray-800">Production History (${sortedProduction.length})</h3>
                            <button onclick="handleExportPdf('production')" class="px-3 py-1.5 text-xs font-medium bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center space-x-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Export PDF</span></button>
                        </div>
                        <div id="production-list-container" class="bg-card-bg p-6 rounded-2xl shadow-lg border border-gray-200/80 h-[650px] overflow-y-auto">
                            ${sortedProduction.length > 0 ? sortedProduction.map(p => {
                                const [product, unit] = p.type.split(' (');
                                const cleanUnit = unit.replace(')', '');

                                return `
                                    <div class="flex justify-between items-center border-b border-gray-100 py-4 last:border-b-0 hover:bg-gray-50/80 transition duration-150 rounded-lg px-2 -mx-2">
                                        <div class="flex flex-col flex-1 min-w-0 pr-4">
                                            <span class="text-base font-semibold text-gray-800 truncate">${product}</span>
                                            <span class="text-xs text-gray-500 mt-0.5">${p.date} | ${p.notes || 'No detailed notes'}</span>
                                        </div>
                                        <div class="flex items-center space-x-3">
                                            <span class="font-bold text-sm text-secondary-yellow bg-yellow-100 border border-yellow-300 px-3 py-1.5 rounded-full min-w-[130px] text-center font-mono">${parseFloat(p.quantity).toFixed(1)} ${cleanUnit}</span>
                                            <button onclick="window.openEditModal('${p.id}', 'production')" class="text-blue-600 hover:text-blue-800 transition p-1.5 rounded-full hover:bg-blue-100" title="Edit">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-3l-4 4V14h3l4-4M16 5l3 3m-8 10h.01"></path></svg>
                                            </button>
                                            <button onclick="window.confirmDelete('${p.id}', 'production')" class="text-red-600 hover:text-red-800 transition p-1.5 rounded-full hover:bg-red-100" title="Delete">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('') : `
                                <p class="text-center text-gray-500 italic py-10">No production recorded yet. Use the form on the left to log your first harvest.</p>
                            `}
                        </div>
                </div>
            `;

            // Note: Charts are now rendered in the Analytics tab
        }

        /**
         * Renders the Task Status doughnut chart.
         */
        function renderTaskStatusChart(tasks) {
            if (taskStatusChart) taskStatusChart.destroy();
            const ctx = document.getElementById('task-status-chart')?.getContext('2d');
            if (!ctx) return;

            const statusCounts = tasks.reduce((acc, task) => {
                acc[task.status] = (acc[task.status] || 0) + 1;
                return acc;
            }, {});

            const labels = farmData.taskStatuses; // Use predefined order
            const data = labels.map(status => statusCounts[status] || 0);

            if (data.every(d => d === 0)) {
                ctx.canvas.parentNode.innerHTML = '<p class="text-center text-gray-500 py-16">No tasks to visualize.</p>';
                return;
            }

            const chartColors = {
                'To Do': '#9ca3af', // Gray 400
                'In Progress': '#60a5fa', // Blue 400
                'Done': '#4ade80' // Green 400
            };

            taskStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: labels.map(label => chartColors[label]),
                        borderColor: '#ffffff',
                        borderWidth: 3,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 12 } } },
                        tooltip: { callbacks: { label: (c) => ` ${c.label}: ${c.parsed.toLocaleString()} tasks` } }
                    }
                }
            }, 0);
        }

        /**
         * Renders the Task & Schedule Planner view.
         */
        function renderTasks(tasks) {
            const container = document.getElementById('view-tasks');

            let filteredTasks = [...tasks];
            // Apply filters from viewFilters.tasks
            if (viewFilters.tasks.isOverdue) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                filteredTasks = filteredTasks.filter(t => t.status !== 'Done' && new Date(t.dueDate) < today);
            }

            // Reset filter after applying it, so next time user visits the page it's not filtered
            if (viewFilters.tasks.isOverdue) {
                viewFilters.tasks.isOverdue = false;
            }

            const sortedTasks = filteredTasks.sort((a, b) => {
                // Sort by status first (To Do > In Progress > Done), then by due date
                const statusOrder = { 'To Do': 0, 'In Progress': 1, 'Done': 2 };
                if (statusOrder[a.status] !== statusOrder[b.status]) {
                    return statusOrder[a.status] - statusOrder[b.status];
                }
                return new Date(a.dueDate) - new Date(b.dueDate);
            });

            const getPriorityClass = (priority) => {
                switch (priority) {
                    case 'High': return 'bg-red-100 text-red-700 border-red-300';
                    case 'Medium': return 'bg-yellow-100 text-yellow-700 border-yellow-300';
                    case 'Low': return 'bg-blue-100 text-blue-700 border-blue-300';
                    default: return 'bg-gray-100 text-gray-700 border-gray-300';
                }
            };

            const getStatusClass = (status) => {
                switch (status) {
                    case 'To Do': return 'bg-gray-200 text-gray-800';
                    case 'In Progress': return 'bg-blue-200 text-blue-800';
                    case 'Done': return 'bg-green-200 text-green-800 line-through';
                    default: return 'bg-gray-200 text-gray-800';
                }
            };

            container.innerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-8">Task & Schedule Planner</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- Add Task Form -->
                    <div class="lg:col-span-1 bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 h-fit">
                        <h3 class="text-xl font-bold mb-5 border-b pb-3 text-gray-800">Add New Task</h3>
                        <form id="add-task-form" onsubmit="event.preventDefault(); handleAddTask();">
                            <div class="mb-4">
                                <label for="task-title" class="block text-sm font-medium text-gray-700 mb-1">Task Title</label>
                                <input type="text" id="task-title" required placeholder="e.g., Repair fence in West pasture" class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition">
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="task-due-date" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                                    <input type="date" id="task-due-date" required class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition" value="${new Date().toISOString().substring(0, 10)}">
                                </div>
                                <div>
                                    <label for="task-priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                    <select id="task-priority" required class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition">
                                        ${farmData.taskPriorities.map(p => `<option value="${p}">${p}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="mb-6">
                                <label for="task-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                <textarea id="task-notes" rows="3" class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-primary-green text-white py-3 rounded-lg font-bold hover:bg-primary-green-dark transition shadow-md shadow-primary-green/40 transform hover:scale-[1.01]">Add Task</button>
                            <p id="task-msg" class="text-center mt-3 text-sm font-medium"></p>
                        </form>
                    </div>

                    <!-- Task List -->
                    <div class="lg:col-span-2">
                        <div class="flex justify-between items-center mb-5 pb-3 border-b">
                            <h3 class="text-xl font-bold text-gray-800">Task Details (${sortedTasks.length})</h3>
                            <button onclick="handleExportPdf('tasks')" class="px-3 py-1.5 text-xs font-medium bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center space-x-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Export PDF</span></button>
                        </div>
                        <div class="bg-card-bg p-6 rounded-2xl shadow-lg border border-gray-200/80">
                            <div class="space-y-4">
                                ${sortedTasks.length > 0 ? sortedTasks.map(task => `
                                    <div class="flex items-start p-4 rounded-lg border ${task.status === 'Done' ? 'bg-gray-50/70 border-gray-200/80' : 'bg-white shadow-sm border-gray-200'} transition-all duration-200">
                                        <div class="flex-grow min-w-0">
                                            <p class="font-semibold text-gray-800 ${getStatusClass(task.status)}">${task.title}</p>
                                            <div class="flex items-center space-x-3 text-xs text-gray-500 mt-1.5">
                                                <span>Due: <span class="font-medium">${task.dueDate}</span></span>
                                                <span class="w-1.5 h-1.5 bg-gray-300 rounded-full"></span>
                                                <span>Priority: <span class="font-medium px-2 py-0.5 rounded-md border text-xs ${getPriorityClass(task.priority)}">${task.priority}</span></span>
                                            </div>
                                            ${task.notes ? `<p class="text-sm text-gray-600 mt-2 italic">"${task.notes}"</p>` : ''}
                                        </div>
                                        <div class="flex items-center space-x-2 ml-4 flex-shrink-0">
                                            <select onchange="handleUpdateTaskStatus('${task.id}', this.value)" class="text-xs p-1 border border-gray-300 rounded-md">
                                                ${farmData.taskStatuses.map(s => `<option value="${s}" ${task.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                            </select>
                                            <button onclick="window.openEditModal('${task.id}', 'tasks')" class="text-blue-600 hover:text-blue-800 transition p-1.5 rounded-full hover:bg-blue-100" title="Edit">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-3l-4 4V14h3l4-4M16 5l3 3m-8 10h.01"></path></svg>
                                            </button>
                                            <button onclick="window.confirmDelete('${task.id}', 'tasks')" class="text-red-600 hover:text-red-800 transition p-1.5 rounded-full hover:bg-red-100" title="Delete">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <p class="text-center text-gray-500 italic py-10">No tasks scheduled. Use the form on the left to add your first task.</p>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Note: Chart is now rendered in the Analytics tab
        }

        /**
         * Renders the Inventory Management view.
         */
        function renderInventory(inventory) {
            const container = document.getElementById('view-inventory');
            const sortedInventory = inventory.slice().sort((a, b) => a.name.localeCompare(b.name));

            container.innerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-8">Inventory Management</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Add Inventory Form -->
                    <div class="lg:col-span-1 bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 h-fit">
                        <h3 class="text-xl font-bold mb-5 border-b pb-3 text-gray-800">Add New Item to Stock</h3>
                        <form id="add-inventory-form" onsubmit="event.preventDefault(); handleAddInventory();">
                            <div class="mb-4">
                                <label for="inventory-name" class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                                <input type="text" id="inventory-name" required placeholder="e.g., Dairy Meal" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="inventory-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                <select id="inventory-category" required class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                                    ${farmData.inventoryCategories.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="inventory-quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                    <input type="number" id="inventory-quantity" required min="0" step="any" placeholder="e.g., 10" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="inventory-unit" class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                                    <input type="text" id="inventory-unit" required placeholder="e.g., kg, bags" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="inventory-threshold" class="block text-sm font-medium text-gray-700 mb-1">Low Stock Alert At (Optional)</label>
                                <input type="number" id="inventory-threshold" min="0" step="any" placeholder="e.g., 5" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="inventory-date" class="block text-sm font-medium text-gray-700 mb-1">Purchase/Stock Date</label>
                                <input type="date" id="inventory-date" required class="input-focus w-full p-3 border border-gray-300 rounded-lg" value="${new Date().toISOString().substring(0, 10)}">
                            </div>
                            <div class="mb-6">
                                <label for="inventory-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes (e.g., supplier, expiry)</label>
                                <textarea id="inventory-notes" rows="2" class="input-focus w-full p-3 border border-gray-300 rounded-lg"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-primary-green text-white py-3 rounded-lg font-bold hover:bg-primary-green-dark transition shadow-md shadow-primary-green/40 transform hover:scale-[1.01]">Add to Inventory</button>
                            <p id="inventory-msg" class="text-center mt-3 text-sm font-medium"></p>
                        </form>
                    </div>

                    <!-- Inventory List Table -->
                    <div class="lg:col-span-2">
                        <div class="flex justify-between items-center mb-5 pb-3 border-b">
                            <h3 class="text-xl font-bold text-gray-800">Current Stock (${sortedInventory.length})</h3>
                            <button onclick="handleExportPdf('inventory')" class="px-3 py-1.5 text-xs font-medium bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center space-x-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Export PDF</span></button>
                        </div>
                        <div class="bg-card-bg rounded-2xl shadow-lg overflow-hidden border border-gray-200/80">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Item Name</th>
                                            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Category</th>
                                            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Quantity</th>
                                            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Stock Date</th>
                                            <th class="px-5 py-3 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-100">
                                        ${sortedInventory.length > 0 ? sortedInventory.map(item => `
                                            <tr class="hover:bg-gray-50/80 transition duration-150">
                                                <td class="px-5 py-3 whitespace-nowrap">
                                                    <div class="text-sm font-semibold text-gray-800">${item.name}</div>
                                                    <div class="text-xs text-gray-500">
                                                        ${item.lowStockThreshold !== null 
                                                            ? `<span class="font-medium text-red-600">Alert at: ${item.lowStockThreshold}</span>` 
                                                            : 'No alert set'}
                                                    </div>
                                                </td>
                                                <td class="px-5 py-3 whitespace-nowrap text-sm text-gray-600">${item.category}</td>
                                                <td class="px-5 py-3 whitespace-nowrap text-sm text-gray-800 font-mono font-semibold">${parseFloat(item.quantity).toLocaleString()} <span class="text-gray-500 font-sans font-normal">${item.unit}</span></td>
                                                <td class="px-5 py-3 whitespace-nowrap text-sm text-gray-600">${item.date}</td>
                                                <td class="px-5 py-3 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                                    <button onclick="window.openEditModal('${item.id}', 'inventory')" class="text-blue-600 hover:text-blue-800 transition p-1.5 rounded-full hover:bg-blue-100" title="Edit">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-3l-4 4V14h3l4-4M16 5l3 3m-8 10h.01"></path></svg>
                                                    </button>
                                                    <button onclick="window.confirmDelete('${item.id}', 'inventory')" class="text-red-600 hover:text-red-800 transition p-1.5 rounded-full hover:bg-red-100" title="Delete">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('') : `
                                            <tr><td colspan="5" class="px-5 py-10 text-center text-gray-500 italic">No inventory items found. Use the form on the left to add your first item.</td></tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the new central Analytics view.
         */
        function renderAnalytics() {
            const container = document.getElementById('view-analytics');
            const defaultYoYType = farmData.productionTypes[0];

            container.innerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-8">Farm Analytics Center</h2>
                <div class="space-y-12">

                    <!-- Financial Analytics -->
                    <section>
                        <h3 class="text-xl font-bold mb-5 pb-3 border-b text-gray-800">Financial Analytics</h3>
                        <div class="bg-card-bg p-6 rounded-2xl shadow-lg border border-gray-200/80">
                            <div class="bg-gray-50/80 p-4 rounded-xl border border-gray-200/90 mb-6">
                                <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">Profitability Trend (Last 12 Months)</h4>
                                <div class="h-80">
                                    <canvas id="monthly-chart"></canvas>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-gray-50/80 p-4 rounded-xl border border-gray-200/90">
                                    <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">Income Source Breakdown</h4>
                                    <div class="h-64">
                                        <canvas id="income-pie-chart"></canvas>
                                    </div>
                                </div>
                                <div class="bg-gray-50/80 p-4 rounded-xl border border-gray-200/90">
                                    <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">Expense Breakdown by Category</h4>
                                    <div class="h-64">
                                        <canvas id="expense-pie-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Profitability Forecast -->
                        <div class="bg-card-bg p-6 rounded-2xl shadow-lg border border-gray-200/80 mt-12">
                            <h3 class="text-xl font-bold mb-5 pb-3 border-b text-gray-800">Profitability Forecast (Next 6 Months)</h3>
                            <div class="h-80">
                                <canvas id="profitability-forecast-chart"></canvas>
                            </div>
                        </div>
                    </section>

                    <!-- Livestock Analytics -->
                    <section>
                        <h3 class="text-xl font-bold mb-5 pb-3 border-b text-gray-800">Livestock Analytics</h3>
                        <div class="grid grid-cols-1 xl:grid-cols-5 gap-6">
                            <div class="xl:col-span-3 bg-card-bg p-6 rounded-2xl shadow-lg border border-gray-200/80">
                                <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">Population Growth (Last 12 Months)</h4>
                                <div class="h-64">
                                    <canvas id="population-growth-chart"></canvas>
                                </div>
                            </div>
                            <div class="xl:col-span-2 bg-card-bg p-6 rounded-2xl shadow-lg border border-gray-200/80">
                                <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">Herd Composition</h4>
                                <div class="h-64">
                                    <canvas id="livestock-composition-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Production Analytics -->
                    <section>
                        <h3 class="text-xl font-bold mb-5 pb-3 border-b text-gray-800">Production Analytics</h3>
                        <div class="space-y-8">
                            <div class="bg-card-bg p-6 rounded-2xl shadow-lg border border-gray-200/80">
                                <div class="flex justify-between items-center mb-4 border-b pb-3">
                                    <h4 class="font-semibold text-gray-700">Year-Over-Year Comparison</h4>
                                    <select id="yoy-product-select" onchange="handleProductionChartUpdate()" class="input-focus p-1 border border-gray-300 rounded-lg text-xs">
                                        ${farmData.productionTypes.map(t => `<option value="${t}" ${t === defaultYoYType ? 'selected' : ''}>${t}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="h-64">
                                    <canvas id="yoy-production-chart"></canvas>
                                </div>
                            </div>
                            <div class="bg-card-bg p-6 rounded-2xl shadow-lg border border-gray-200/80">
                                 <div class="flex justify-between items-center mb-4 border-b pb-3">
                                    <h4 class="font-semibold text-gray-700">Production Trends (Last 12 Months)</h4>
                                    <div id="trend-product-select" class="flex items-center space-x-3">
                                        ${farmData.productionTypes.map((type, i) => `
                                            <label class="flex items-center text-xs">
                                                <input type="checkbox" value="${type}" onchange="handleProductionChartUpdate()" class="h-4 w-4 rounded border-gray-300 text-primary-green focus:ring-primary-green" ${i < 2 ? 'checked' : ''}>
                                                <span class="ml-1.5">${type.split(' ')[0]}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="h-64 relative">
                                    <div id="production-trend-no-data" class="absolute inset-0 flex items-center justify-center hidden">
                                        <p class="text-center text-gray-500 py-16">No data for selected products in the last 12 months.</p>
                                    </div>
                                    <canvas id="production-trend-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            `;

            // Render all charts
            setTimeout(() => {
                renderCharts(farmData.transactions);
                renderLivestockCompositionChart(farmData.livestock);
                renderPopulationGrowthChart(farmData.livestock);
                handleProductionChartUpdate();
                // Ensure the "no data" message is hidden and canvas is visible on initial load
                renderProfitabilityForecastChart(farmData.transactions);
                const trendChartCanvas = document.getElementById('production-trend-chart');
                if (trendChartCanvas) {
                    trendChartCanvas.classList.remove('hidden');
                    trendChartCanvas.parentNode.querySelector('#production-trend-no-data')?.classList.add('hidden');
                }
                renderTaskStatusChart(farmData.tasks);
            }, 0);
        }

        /**
         * Updates the Category dropdown based on the selected Transaction Type (Income/Expense).
         * @param {string} categoryId - The ID of the category dropdown to update.
         * @param {string} selectedCategory - Optional existing category to pre-select.
         * @param {string} typeId - The ID of the transaction type dropdown.
         */
        window.updateTransactionCategories = function(categoryId, selectedCategory = null, typeId = 'transaction-type') {
            const typeSelect = document.getElementById(typeId);
            const categorySelect = document.getElementById(categoryId);
            if (!typeSelect || !categorySelect) return;

            const selectedType = typeSelect.value;
            const categories = farmData.transactionCategories[selectedType] || [];

            categorySelect.innerHTML = categories
                .map(cat => `<option value="${cat}" ${selectedCategory === cat ? 'selected' : ''}>${cat}</option>`)
                .join('');
        }

        /**
         * Generates and downloads a PDF for a given table.
         */
        window.handleExportPdf = function(collectionName) {
            const { jsPDF } = window.jspdf;
            if (!jsPDF || !window.jspdf.autoTable) {
                alert('PDF generation library is not loaded.');
                return;
            }
            const doc = new jsPDF();

            let title, headers, data, filename;
            const now = new Date().toISOString().split('T')[0];

            switch (collectionName) {
                case 'livestock':
                    title = 'Livestock Records';
                    headers = ['Type', 'Count', 'Acquisition Date', 'Notes'];
                    data = farmData.livestock.map(i => [i.type, i.count, i.date, i.notes || '']);
                    filename = `livestock-records_${now}.pdf`;
                    break;
                case 'transactions':
                    const filteredTransactions = filterTransactions(farmData.transactions, viewFilters.finance);
                    title = 'Financial Transactions';
                    headers = ['Date', 'Type', 'Category', 'Amount (KSh)', 'Notes'];
                    data = filteredTransactions.map(i => [i.date, i.type, i.category, i.amount.toFixed(2), i.notes || '']);
                    filename = `financial-transactions_${now}.pdf`;
                    break;
                case 'production':
                    title = 'Production History';
                    headers = ['Date', 'Product Type', 'Quantity', 'Notes'];
                    data = farmData.production.map(i => [i.date, i.type, i.quantity, i.notes || '']);
                    filename = `production-history_${now}.pdf`;
                    break;
                case 'tasks':
                    title = 'Task List';
                    headers = ['Due Date', 'Title', 'Priority', 'Status', 'Notes'];
                    data = farmData.tasks.map(i => [i.dueDate, i.title, i.priority, i.status, i.notes || '']);
                    filename = `task-list_${now}.pdf`;
                    break;
                case 'inventory':
                    title = 'Inventory Stock';
                    headers = ['Item Name', 'Category', 'Quantity', 'Unit', 'Stock Date', 'Notes'];
                    data = farmData.inventory.map(i => [i.name, i.category, i.quantity, i.unit, i.date, i.notes || '']);
                    filename = `inventory-stock_${now}.pdf`;
                    break;
                case 'breeding':
                    title = 'Breeding Records';
                    headers = ['Animal ID', 'Species', 'Service Date', 'Expected Due Date', 'Status'];
                    data = farmData.breeding.map(i => [i.animalId, i.species, i.serviceDate, i.expectedDueDate, i.status]);
                    filename = `breeding-records_${now}.pdf`;
                    break;
                case 'health':
                    title = 'Health Records';
                    headers = ['Date', 'Animal ID', 'Diagnosis', 'Treatment', 'Veterinarian'];
                    data = farmData.health.map(i => [i.recordDate, i.animalId, i.diagnosis, i.treatment || '', i.veterinarian || '']);
                    filename = `health-records_${now}.pdf`;
                    break;
                default:
                    return; // Do nothing if collection is unknown
            }

            doc.autoTable({
                head: [headers],
                body: data,
                startY: 20,
                didDrawPage: function(data) {
                    doc.setFontSize(18);
                    doc.text(title, data.settings.margin.left, 15);
                }
            });
            doc.save(filename);
        }

        // --- CRUD OPERATIONS (LOCAL) ---

        /**
         * Retrieves a record by ID and collection name.
         * @param {string} id 
         * @param {string} collectionName 
         * @returns {Object|undefined} The record object.
         */
        function getRecordById(id, collectionName) {
            return farmData[collectionName].find(item => item.id === id);
        }

        /**
         * Handles the submission of the Add Livestock form.
         */
        window.handleAddLivestock = async function() {
            const type = document.getElementById('livestock-type').value;
            const count = parseInt(document.getElementById('livestock-count').value);
            const date = document.getElementById('livestock-date').value;
            const notes = document.getElementById('livestock-notes').value.trim();
            const msgEl = document.getElementById('livestock-msg');
            msgEl.className = 'text-center mt-3 text-sm font-medium';
            msgEl.textContent = 'Saving...';

            const record = { 
                type, 
                count, 
                date, 
                notes
            };

            if (!type || isNaN(count) || count <= 0 || !date) {
                msgEl.textContent = 'Please fill all required fields correctly.';
                msgEl.className = 'text-center mt-3 text-sm text-red-500 font-medium';
                return;
            }

            record.id = Date.now().toString(); // Assign a local unique ID
            farmData.livestock.push(record);
            farmData.livestock.sort((a, b) => new Date(b.date) - new Date(a.date));
            saveData();
            renderLivestock(farmData.livestock);

            msgEl.textContent = `${count.toLocaleString()} ${type} added successfully!`;
            msgEl.className = 'text-center mt-3 text-sm text-green-600 font-medium';
            document.getElementById('add-livestock-form').reset();
            document.getElementById('livestock-date').value = new Date().toISOString().substring(0, 10);
            setTimeout(() => msgEl.textContent = '', 3000);
        }

        /**
         * Handles the submission of the Add Transaction form.
         */
        window.handleAddTransaction = async function() {
            const type = document.getElementById('transaction-type').value;
            const category = document.getElementById('transaction-category').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const date = document.getElementById('transaction-date').value;
            const notes = document.getElementById('transaction-notes').value.trim();
            const msgEl = document.getElementById('transaction-msg');
            msgEl.className = 'text-center mt-3 text-sm font-medium';
            msgEl.textContent = 'Saving...';

            if (!type || !category || isNaN(amount) || amount <= 0 || !date) {
                msgEl.textContent = 'Please fill all required fields correctly.';
                msgEl.className = 'text-center mt-3 text-sm text-red-500 font-medium';
                return;
            }

            const record = {
                type, 
                category, 
                amount, 
                date, 
                notes
            };
            
            record.id = Date.now().toString(); // Assign a local unique ID
            farmData.transactions.push(record);
            farmData.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            saveData();
            renderTransactions(farmData.transactions);

            msgEl.textContent = `${type.toUpperCase()} of KSh ${amount.toFixed(2).toLocaleString()} recorded successfully!`;
            msgEl.className = 'text-center mt-3 text-sm text-green-600 font-medium';
            document.getElementById('add-transaction-form').reset();
            document.getElementById('transaction-date').value = new Date().toISOString().substring(0, 10);
            updateTransactionCategories('transaction-category'); // Reset categories
            setTimeout(() => msgEl.textContent = '', 3000);
        }
        
        /**
         * Handles the submission of the Add Production form.
         */
        window.handleAddProduction = async function() {
            const type = document.getElementById('production-type').value;
            const quantity = parseFloat(document.getElementById('production-quantity').value);
            const date = document.getElementById('production-date').value;
            const notes = document.getElementById('production-notes').value.trim();
            const msgEl = document.getElementById('production-msg');

            if (!type || isNaN(quantity) || quantity <= 0 || !date) {
                msgEl.textContent = 'Please fill all required fields correctly.';
                msgEl.className = 'text-center mt-3 text-sm text-red-500 font-medium';
                return;
            }

            const record = { 
                type, 
                quantity, 
                date, 
                notes
            };
            
            record.id = Date.now().toString(); // Assign a local unique ID
            farmData.production.push(record);
            farmData.production.sort((a, b) => new Date(b.date) - new Date(a.date));
            saveData();
            renderProduction(farmData.production);

            const unit = type.split('(')[1].replace(')', '');
            msgEl.textContent = `${quantity.toFixed(1).toLocaleString()} ${unit} of ${type.split(' ')[0]} logged successfully!`;
            msgEl.className = 'text-center mt-3 text-sm text-green-600 font-medium';
            document.getElementById('add-production-form').reset();
            document.getElementById('production-date').value = new Date().toISOString().substring(0, 10);

            setTimeout(() => msgEl.textContent = '', 3000);
        }

        /**
         * Handles the submission of the Add Task form.
         */
        window.handleAddTask = async function() {
            const title = document.getElementById('task-title').value.trim();
            const dueDate = document.getElementById('task-due-date').value;
            const priority = document.getElementById('task-priority').value;
            const notes = document.getElementById('task-notes').value.trim();
            const msgEl = document.getElementById('task-msg');

            if (!title || !dueDate || !priority) {
                msgEl.textContent = 'Please fill all required fields.';
                msgEl.className = 'text-center mt-3 text-sm text-red-500 font-medium';
                return;
            }

            const record = { 
                title, 
                dueDate, 
                priority, 
                notes, 
                status: 'To Do' // Default status
            };
            
            record.id = Date.now().toString(); // Assign a local unique ID
            farmData.tasks.push(record);
            saveData();
            renderTasks(farmData.tasks);

            msgEl.textContent = `Task added successfully!`;
            msgEl.className = 'text-center mt-3 text-sm text-green-600 font-medium';
            document.getElementById('add-task-form').reset();
            document.getElementById('task-due-date').value = new Date().toISOString().substring(0, 10);

            setTimeout(() => msgEl.textContent = '', 3000);
        }

        /**
         * Handles the submission of the Add Inventory form.
         */
        window.handleAddInventory = async function() {
            const name = document.getElementById('inventory-name').value.trim();
            const category = document.getElementById('inventory-category').value;
            const quantity = parseFloat(document.getElementById('inventory-quantity').value);
            const unit = document.getElementById('inventory-unit').value.trim();
            const date = document.getElementById('inventory-date').value;
            const threshold = document.getElementById('inventory-threshold').value;
            const notes = document.getElementById('inventory-notes').value.trim();
            const msgEl = document.getElementById('inventory-msg');

            if (!name || !category || isNaN(quantity) || quantity < 0 || !unit || !date) {
                msgEl.textContent = 'Please fill all required fields correctly.';
                msgEl.className = 'text-center mt-3 text-sm text-red-500 font-medium';
                return;
            }

            const record = { 
                name, 
                category, 
                quantity, 
                unit, 
                date, 
                lowStockThreshold: threshold ? parseFloat(threshold) : null,
                notes
            };
            
            record.id = Date.now().toString(); // Assign a local unique ID
            farmData.inventory.push(record);
            saveData();
            renderInventory(farmData.inventory);

            msgEl.textContent = `Item '${name}' added successfully!`;
            msgEl.className = 'text-center mt-3 text-sm text-green-600 font-medium';
            document.getElementById('add-inventory-form').reset();
            document.getElementById('inventory-date').value = new Date().toISOString().substring(0, 10);

            setTimeout(() => msgEl.textContent = '', 3000);
        }

        /**
         * Handles adding a new delegate user.
         */
        window.handleAddDelegate = function() {
            const newDelegateId = document.getElementById('new-delegate-id').value.trim();
            const newDelegatePass = document.getElementById('new-delegate-password').value;
            // This functionality is more complex with a database.
            // It would require an API endpoint to create a new user with `is_owner=0`
            alert("Delegate management is not supported in local storage mode.");
        }

        /**
         * Handles removing a delegate user.
         */
        window.handleRemoveDelegate = function(delegateId) {
            if (!confirm(`Are you sure you want to remove access for user '${delegateId}'?`)) {
                return;
            }
            alert("Delegate management is not supported in local storage mode.");
        }

        /**
         * Renders the Settings page.
         */
        function renderSettings() {
            const container = document.getElementById('view-settings');            
            const isOwner = true; // Simplified for now. You'd check this from the session.

            let userManagementHtml = '';
            let passwordChangeHtml = '';

            if (isOwner) {
                // --- User Management Section ---
                const delegates = owner.delegates || [];
                const canAddMore = delegates.length < 3;

                const delegateListHtml = delegates.map(delegateId => `
                    <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg">
                        <span class="font-medium text-gray-700">${delegateId.userId}</span>
                        <button onclick="handleRemoveDelegate('${delegateId.userId}')" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100" title="Remove User">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `).join('');

                const addDelegateFormHtml = canAddMore ? `
                    <form onsubmit="event.preventDefault(); handleAddDelegate();" class="flex items-center space-x-2 mt-4">
                        <input type="text" id="new-delegate-id" required placeholder="New User ID" class="input-focus flex-grow p-2 border border-gray-300 rounded-lg text-sm" pattern="[a-z0-9_]+">
                        <input type="password" id="new-delegate-password" required placeholder="Set Initial Password" class="input-focus flex-grow p-2 border border-gray-300 rounded-lg text-sm">
                        <button type="submit" class="px-4 py-2 bg-primary-green text-white text-sm font-semibold rounded-lg hover:bg-primary-green-dark transition flex-shrink-0">Add User</button>
                    </form>
                    <p id="delegate-msg" class="text-xs text-center mt-2"></p>
                ` : `<p class="text-sm text-center text-gray-500 mt-4">You have reached the maximum of 3 delegate users.</p>`;

                userManagementHtml = `
                    <!-- User Management Card -->
                    <div class="bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80 mt-10">
                        <h3 class="text-xl font-bold mb-5 border-b pb-3 text-gray-800 flex items-center">
                            <svg class="w-6 h-6 mr-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            User Management
                        </h3>
                        <div class="space-y-3 mb-4">
                            <p class="text-sm text-gray-600">You can grant access to your farm data for up to 3 other users. They will log in with their own User ID and password. Only you can manage users and change the primary account password.</p>
                            ${delegateListHtml || '<p class="text-sm text-gray-500 italic text-center py-2">No delegate users added yet.</p>'}
                        </div>
                        ${addDelegateFormHtml}
                    </div>
                `;

                // --- Password Change Section ---
                passwordChangeHtml = `
                    <div class="bg-card-bg p-8 rounded-2xl shadow-lg border border-gray-200/80">
                        <h3 class="text-xl font-bold mb-5 border-b pb-3 text-gray-800">Change Your Password</h3>
                        <form id="change-password-form" onsubmit="event.preventDefault(); handleChangePassword();">
                            <div class="mb-4">
                                <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                                <input type="password" id="current-password" required placeholder="Enter your current password" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                                <input type="password" id="new-password" required placeholder="Enter a new strong password" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-6">
                                <label for="confirm-new-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                                <input type="password" id="confirm-new-password" required placeholder="Confirm your new password" class="input-focus w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <button type="submit" class="w-full bg-primary-green text-white py-3 rounded-lg font-bold hover:bg-primary-green-dark transition shadow-md">Update Password</button>
                            <p id="password-msg" class="text-center mt-4 text-sm font-medium"></p>
                        </form>
                    </div>
                `;
            } else {
                passwordChangeHtml = `
                    <div class="bg-blue-50 p-8 rounded-2xl border-2 border-blue-200/80 text-center">
                        <h3 class="text-lg font-semibold text-blue-800">Account Management</h3>
                        <p class="text-blue-700 mt-2">As a delegate user, you cannot change the account password. Please contact the primary account owner if a password change is needed.</p>
                    </div>
                `;
            }

            container.innerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-8">Account Settings</h2>
                <div class="max-w-2xl mx-auto">
                    ${passwordChangeHtml}
                    ${userManagementHtml}
                </div>
            `;
        }

        /**
         * Handles the password change request from the Settings page.
         */
        window.handleChangePassword = function() {
            const currentPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmNewPass = document.getElementById('confirm-new-password').value;
            const msgEl = document.getElementById('password-msg');

            if (currentPass !== owner.password) {
                msgEl.textContent = 'Current password is incorrect.';
                msgEl.className = 'text-center mt-4 text-sm font-medium text-red-500';
                return;
            }
            if (newPass.length < 6) {
                msgEl.textContent = 'New password must be at least 6 characters long.';
                msgEl.className = 'text-center mt-4 text-sm font-medium text-red-500';
                return;
            }
            if (newPass !== confirmNewPass) {
                msgEl.textContent = 'New passwords do not match.';
                msgEl.className = 'text-center mt-4 text-sm font-medium text-red-500';
                return;
            }

            owner.password = newPass;
            localStorage.setItem('farmOwner', JSON.stringify(owner));

            msgEl.textContent = 'Password updated successfully! It will be used the next time you log in.';
            msgEl.className = 'text-center mt-4 text-sm font-medium text-green-600';
            document.getElementById('change-password-form').reset();
        }

        // --- DELETE MODAL HANDLERS ---

        /**
         * Displays a confirmation modal before deleting a record.
         */
        window.confirmDelete = function(id, collectionName) {
            const modal = document.getElementById('delete-modal-backdrop');
            const message = document.getElementById('delete-modal-message');
            const modalContent = document.getElementById('delete-modal-content');
            const confirmBtn = document.getElementById('delete-modal-confirm-btn');

            message.textContent = `Are you sure you want to permanently delete this ${collectionName.slice(0, -1)} record? This action cannot be undone.`;
            
            // Re-clone the button to remove old event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            // Bind the delete handler
            newConfirmBtn.onclick = () => handleDelete(id, collectionName);

            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10); // Small delay to allow transition
        }

        /**
         * Performs the actual delete operation in local storage.
         */
        async function handleDelete(id, collectionName) {
            window.closeModal('delete');
            
            farmData[collectionName] = farmData[collectionName].filter(item => item.id !== id);
            saveData();
            
            // Special handling for animal hub sub-views
            if (collectionName === 'breeding' || collectionName === 'health') {
                renderAnimalHub(collectionName);
            } else if (collectionName !== 'equipment') { // Equipment re-renders its own view
                window.changeView(collectionName); // Re-render the current view to show deletion
            } else {
                renderEquipment(farmData.equipment);
            }
        }


        // --- EDIT MODAL HANDLERS (NEW) ---

        /**
         * Generates the dynamic form content for the edit modal based on the record type.
         */
        function generateEditForm(record, collectionName) {
            const id = record.id;
            const recordType = collectionName.slice(0, -1).charAt(0).toUpperCase() + collectionName.slice(0, -1).slice(1);
            let formHtml = '';

            const input = (id, label, type, value, step = null) => `
                <div class="mb-4">
                    <label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                    <input type="${type}" id="${id}" name="${id}" required 
                           class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition" 
                           value="${value}" ${step ? `step="${step}"` : ''}>
                </div>
            `;
            
            const select = (id, label, options, selectedValue, onChangeHandler = '') => {
                const optionsHtml = options.map(opt => {
                    const value = opt.value || opt;
                    const text = opt.text || (opt.charAt(0).toUpperCase() + opt.slice(1));
                    return `<option value="${value}" ${selectedValue === value ? 'selected' : ''}>${text}</option>`;
                }).join('');

                return `
                    <div class="mb-4">
                        <label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                        <select id="${id}" name="${id}" required 
                                ${onChangeHandler ? `onchange="${onChangeHandler}"` : ''}
                                class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition">
                            ${optionsHtml}
                        </select>
                    </div>
                `;
            };

            const textarea = (id, label, value) => `
                <div class="mb-6">
                    <label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                    <textarea id="${id}" name="${id}" rows="3" class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition">${value || ''}</textarea>
                </div>
            `;

            switch (collectionName) {
                case 'livestock':
                    formHtml = `
                        ${select('edit-livestock-type', 'Type', farmData.livestockTypes, record.type)}
                        ${input('edit-livestock-count', 'Quantity/Count', 'number', record.count, 1)}
                        ${input('edit-livestock-date', 'Acquisition/Birth Date', 'date', record.date)}
                        ${textarea('edit-livestock-notes', 'Notes (e.g., breed, source)', record.notes)}
                        <input type="hidden" id="edit-record-id" value="${id}">
                        <input type="hidden" id="edit-collection-name" value="${collectionName}">
                    `;
                    break;

                case 'transactions':
                    const typeOptions = [
                        { value: 'expense', text: 'Expense (Input)' },
                        { value: 'income', text: 'Income (Sale)' }
                    ];

                    const categoryHtml = `
                        ${select('edit-transaction-type', 'Transaction Type', typeOptions, record.type, `updateTransactionCategories('edit-transaction-category', null, 'edit-transaction-type')`)}
                        <div class="mb-4">
                            <label for="edit-transaction-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="edit-transaction-category" name="edit-transaction-category" required class="input-focus w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-green focus:border-primary-green transition">
                                <!-- Populated dynamically -->
                            </select>
                        </div>
                    `;

                    formHtml = `
                        ${categoryHtml}
                        ${input('edit-transaction-amount', 'Amount (KSh)', 'number', record.amount, 0.01)}
                        ${input('edit-transaction-date', 'Date', 'date', record.date)}
                        ${textarea('edit-transaction-notes', 'Notes (e.g., supplier, item quantity)', record.notes)}
                        <input type="hidden" id="edit-record-id" value="${id}">
                        <input type="hidden" id="edit-collection-name" value="${collectionName}">
                    `;
                    
                    // Delay category update to ensure DOM is ready
                    setTimeout(() => {
                        updateTransactionCategories('edit-transaction-category', record.category, 'edit-transaction-type');
                    }, 0);
                    
                    break;

                case 'production':
                    formHtml = `
                        ${select('edit-production-type', 'Product Type', farmData.productionTypes, record.type)}
                        ${input('edit-production-quantity', 'Quantity', 'number', record.quantity, 0.1)}
                        ${input('edit-production-date', 'Harvest Date', 'date', record.date)}
                        ${textarea('edit-production-notes', 'Notes (e.g., area harvested, specific herd)', record.notes)}
                        <input type="hidden" id="edit-record-id" value="${id}">
                        <input type="hidden" id="edit-collection-name" value="${collectionName}">
                    `;
                    break;
                
                case 'tasks':
                    formHtml = `
                        ${input('edit-task-title', 'Task Title', 'text', record.title)}
                        <div class="grid grid-cols-2 gap-4">
                            ${input('edit-task-due-date', 'Due Date', 'date', record.dueDate)}
                            ${select('edit-task-priority', 'Priority', farmData.taskPriorities, record.priority)}
                        </div>
                        ${select('edit-task-status', 'Status', farmData.taskStatuses, record.status)}
                        ${textarea('edit-task-notes', 'Notes', record.notes)}
                        <input type="hidden" id="edit-record-id" value="${id}">
                        <input type="hidden" id="edit-collection-name" value="${collectionName}">
                    `;
                    break;

                case 'inventory':
                    formHtml = `
                        ${input('edit-inventory-name', 'Item Name', 'text', record.name)}
                        ${select('edit-inventory-category', 'Category', farmData.inventoryCategories, record.category)}
                        <div class="grid grid-cols-2 gap-4">
                            ${input('edit-inventory-quantity', 'Quantity', 'number', record.quantity, 'any')}
                            ${input('edit-inventory-unit', 'Unit', 'text', record.unit)}
                        </div>
                        ${input('edit-inventory-threshold', 'Low Stock Alert At (Optional)', 'number', record.lowStockThreshold, 'any')}
                        ${input('edit-inventory-date', 'Purchase/Stock Date', 'date', record.date)}
                        ${textarea('edit-inventory-notes', 'Notes (e.g., supplier, expiry)', record.notes)}
                        <input type="hidden" id="edit-record-id" value="${id}">
                        <input type="hidden" id="edit-collection-name" value="${collectionName}">
                    `;
                    break;

                case 'breeding':
                    formHtml = `
                        ${input('edit-breeding-animal-id', 'Animal ID', 'text', record.animalId)}
                        ${select('edit-breeding-species', 'Species', farmData.animalSpecies, record.species)}
                        ${input('edit-breeding-service-date', 'Service Date', 'date', record.serviceDate)}
                        ${select('edit-breeding-status', 'Status', farmData.breedingStatuses, record.status)}
                        <input type="hidden" id="edit-record-id" value="${id}">
                        <input type="hidden" id="edit-collection-name" value="${collectionName}">
                    `;
                    break;

                case 'health':
                    formHtml = `
                        ${input('edit-health-animal-id', 'Animal ID', 'text', record.animalId)}
                        ${input('edit-health-record-date', 'Record Date', 'date', record.recordDate)}
                        ${textarea('edit-health-diagnosis', 'Diagnosis', record.diagnosis)}
                        ${textarea('edit-health-treatment', 'Treatment', record.treatment)}
                        ${input('edit-health-veterinarian', 'Veterinarian', 'text', record.veterinarian)}
                        <input type="hidden" id="edit-record-id" value="${id}">
                        <input type="hidden" id="edit-collection-name" value="${collectionName}">
                    `;
                    break;

                case 'equipment':
                    formHtml = `
                        ${input('edit-equipment-name', 'Equipment Name', 'text', record.name)}
                        ${input('edit-equipment-model', 'Model/Serial #', 'text', record.model)}
                        ${input('edit-equipment-purchase-date', 'Purchase Date', 'date', record.purchaseDate)}
                        <p class="text-xs text-gray-500 italic mt-4">Note: Maintenance logs are managed directly on the Equipment page.</p>
                        <input type="hidden" id="edit-record-id" value="${id}">
                        <input type="hidden" id="edit-collection-name" value="${collectionName}">
                    `;
                    break;


            }

            return { html: formHtml, title: `Edit ${recordType} Record` };
        }

        /**
         * Opens the dedicated modal for editing a record.
         */
        window.openEditModal = function(id, collectionName) {
            const record = getRecordById(id, collectionName);
            if (!record) {
                console.error(`Record with ID ${id} not found in ${collectionName}`);
                return;
            }

            currentEditingRecord = { id, collectionName };

            const { html, title } = generateEditForm(record, collectionName);
            const modal = document.getElementById('edit-modal-backdrop');
            const modalContent = document.getElementById('edit-modal-content');

            document.getElementById('edit-form-content').innerHTML = html;
            document.getElementById('edit-modal-title').textContent = title;
            document.getElementById('edit-msg').textContent = '';
            document.getElementById('edit-msg').classList.add('hidden');

            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10); // Small delay to allow transition
        }


        /**
         * Handles the form submission within the edit modal to update the record.
         */
        window.handleUpdateRecord = async function() {
            const { id, collectionName } = currentEditingRecord;
            const record = getRecordById(id, collectionName);
            if (!record) return;

            const msgEl = document.getElementById('edit-msg');
            msgEl.classList.remove('hidden', 'text-green-600', 'text-red-500');

            try {
                let updatedRecord = { id };
                let isValid = false;
                // Update logic based on collection type
                switch (collectionName) {
                    case 'livestock':
                        updatedRecord.type = document.getElementById('edit-livestock-type').value;
                        updatedRecord.count = parseInt(document.getElementById('edit-livestock-count').value);
                        updatedRecord.date = document.getElementById('edit-livestock-date').value;
                        updatedRecord.notes = document.getElementById('edit-livestock-notes').value.trim();

                        if (updatedRecord.type && !isNaN(updatedRecord.count) && updatedRecord.count > 0 && updatedRecord.date) {
                            isValid = true;
                        }
                        break;

                    case 'transactions':
                        updatedRecord.type = document.getElementById('edit-transaction-type').value;
                        updatedRecord.category = document.getElementById('edit-transaction-category').value;
                        updatedRecord.amount = parseFloat(document.getElementById('edit-transaction-amount').value);
                        updatedRecord.date = document.getElementById('edit-transaction-date').value;
                        updatedRecord.notes = document.getElementById('edit-transaction-notes').value.trim();

                        if (updatedRecord.type && updatedRecord.category && !isNaN(updatedRecord.amount) && updatedRecord.amount > 0 && updatedRecord.date) {
                            isValid = true;
                        }
                        break;
                    
                    case 'production':
                        updatedRecord.type = document.getElementById('edit-production-type').value;
                        updatedRecord.quantity = parseFloat(document.getElementById('edit-production-quantity').value);
                        updatedRecord.date = document.getElementById('edit-production-date').value;
                        updatedRecord.notes = document.getElementById('edit-production-notes').value.trim();

                        if (updatedRecord.type && !isNaN(updatedRecord.quantity) && updatedRecord.quantity > 0 && updatedRecord.date) {
                            isValid = true;
                        }
                        break;
                    
                    case 'tasks':
                        updatedRecord.title = document.getElementById('edit-task-title').value.trim();
                        updatedRecord.dueDate = document.getElementById('edit-task-due-date').value;
                        updatedRecord.priority = document.getElementById('edit-task-priority').value;
                        updatedRecord.status = document.getElementById('edit-task-status').value;
                        updatedRecord.notes = document.getElementById('edit-task-notes').value.trim();

                        if (updatedRecord.title && updatedRecord.dueDate && updatedRecord.priority && updatedRecord.status) {
                            isValid = true;
                        }
                        break;
                    
                    case 'inventory':
                        updatedRecord.name = document.getElementById('edit-inventory-name').value.trim();
                        updatedRecord.category = document.getElementById('edit-inventory-category').value;
                        updatedRecord.quantity = parseFloat(document.getElementById('edit-inventory-quantity').value);
                        updatedRecord.unit = document.getElementById('edit-inventory-unit').value.trim();
                        updatedRecord.date = document.getElementById('edit-inventory-date').value;
                        updatedRecord.lowStockThreshold = document.getElementById('edit-inventory-threshold').value;
                        updatedRecord.notes = document.getElementById('edit-inventory-notes').value.trim();

                        if (updatedRecord.name && updatedRecord.category && !isNaN(updatedRecord.quantity) && updatedRecord.quantity >= 0 && updatedRecord.unit && updatedRecord.date) {
                            updatedRecord.lowStockThreshold = updatedRecord.lowStockThreshold ? parseFloat(updatedRecord.lowStockThreshold) : null;
                            isValid = true;
                        }
                        break;
                    
                    case 'breeding':
                        updatedRecord.animalId = document.getElementById('edit-breeding-animal-id').value.trim();
                        updatedRecord.species = document.getElementById('edit-breeding-species').value;
                        updatedRecord.serviceDate = document.getElementById('edit-breeding-service-date').value;
                        updatedRecord.status = document.getElementById('edit-breeding-status').value;

                        if (updatedRecord.animalId && updatedRecord.species && updatedRecord.serviceDate && updatedRecord.status) {
                            updatedRecord.expectedDueDate = calculateDueDate(updatedRecord.serviceDate, updatedRecord.species);
                            isValid = true;
                        }
                        break;

                    case 'health':
                        updatedRecord.animalId = document.getElementById('edit-health-animal-id').value.trim();
                        updatedRecord.recordDate = document.getElementById('edit-health-record-date').value;
                        updatedRecord.diagnosis = document.getElementById('edit-health-diagnosis').value.trim();
                        updatedRecord.treatment = document.getElementById('edit-health-treatment').value.trim();
                        updatedRecord.veterinarian = document.getElementById('edit-health-veterinarian').value.trim();

                        if (updatedRecord.animalId && updatedRecord.recordDate && updatedRecord.diagnosis) {
                            isValid = true;
                        }
                        break;

                    case 'equipment':
                        updatedRecord.name = document.getElementById('edit-equipment-name').value.trim();
                        updatedRecord.model = document.getElementById('edit-equipment-model').value.trim();
                        updatedRecord.purchaseDate = document.getElementById('edit-equipment-purchase-date').value;

                        if (updatedRecord.name && updatedRecord.purchaseDate) {
                            isValid = true;
                        }
                        break;
                }

                if (isValid) {
                    // Update local data
                    Object.assign(record, updatedRecord);
                    saveData();

                    if (collectionName === 'equipment') {
                        renderEquipment(farmData.equipment);
                    } else if (collectionName === 'breeding' || collectionName === 'health') {
                        renderAnimalHub(collectionName);
                    } else {
                        window.changeView(collectionName); // Re-render the current view to show changes
                    }
                    msgEl.textContent = 'Record updated successfully!';
                    msgEl.className = 'text-center mt-4 text-sm text-green-600 font-medium';
                    setTimeout(() => window.closeModal('edit'), 1000);
                } else {
                    msgEl.textContent = 'Validation error: Please check all fields.';
                    msgEl.className = 'text-center mt-4 text-sm text-red-500 font-medium';
                }

            } catch (error) {
                msgEl.textContent = `Error: ${error.message}`;
                msgEl.className = 'text-center mt-4 text-sm text-red-500 font-medium';
            }
        }

        /**
         * Handles inline status updates for tasks.
         */
        window.handleUpdateTaskStatus = async function(id, newStatus) {
            const record = getRecordById(id, 'tasks');
            if (record) {
                const originalStatus = record.status;
                try {
                    record.status = newStatus; // Optimistic update
                    renderTasks(farmData.tasks);

                    saveData();
                } catch (error) {
                    record.status = originalStatus; // Revert on failure
                    renderTasks(farmData.tasks);
                    alert('Could not update task status. Please try again.');
                }
            }
        }


        /**
         * Closes a specific modal.
         * @param {string} modalType - 'delete' or 'edit'.
         */
        window.closeModal = function(modalType) {
            const modalBackdrop = document.getElementById(`${modalType}-modal-backdrop`);
            const modalContent = document.getElementById(`${modalType}-modal-content`);

            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');

            setTimeout(() => modalBackdrop.classList.add('hidden'), 300); // Wait for animation

            if (modalType === 'edit') {
                currentEditingRecord = null; // Clear editing state
            }
        }

        /**
         * Toggles the mobile navigation dropdown menu.
         */
        window.toggleNavDropdown = function() {
            const menu = document.getElementById('nav-dropdown-menu');
            const icon = document.getElementById('nav-dropdown-icon');
            menu.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }

        /**
         * Handles item selection from the mobile navigation dropdown.
         */
        window.selectNavDropdownItem = function(viewName) {
            // Change the view
            changeView(viewName);

            // Close the dropdown
            const menu = document.getElementById('nav-dropdown-menu');
            const icon = document.getElementById('nav-dropdown-icon');
            menu.classList.add('hidden');
            icon.classList.remove('rotate-180');
        }

        /**
         * Shows the splash screen due to user inactivity.
         */
        function handleInactivityLogout() {
            clearTimeout(inactivityTimer);
            alert("You have been logged out due to inactivity.");
            // Securely log out by reloading the page
            handleLogout();
        }

        /**
         * Resets the inactivity timer whenever the user interacts with the page.
         */
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(handleInactivityLogout, INACTIVITY_TIMEOUT);
        }

        /**
         * Sets up event listeners to detect user activity.
         */
        function setupActivityListeners() {
            ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event =>
                window.addEventListener(event, resetInactivityTimer, { passive: true })
            );
        }

        /**
         * Hides the splash screen and reveals the main application content.
         */
        function showApp() {
            const splashScreen = document.getElementById('splash-screen');
            const appContainer = document.getElementById('app');

            // Fade out splash screen
            splashScreen.style.opacity = '0';
            // After splash screen is gone, fade in the app
            setTimeout(() => {
                splashScreen.style.display = 'none';
                appContainer.style.opacity = '1';

                // Start tracking inactivity only after the app is fully visible
                setupActivityListeners();
                resetInactivityTimer();
            }, 700); // Must match splash screen transition duration
        }

        // Execute initialization when the DOM is ready
        initializeLocalApp();

    </script>
</body>
</html>
